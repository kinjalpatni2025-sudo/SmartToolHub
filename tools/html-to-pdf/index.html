<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HTML → PDF Converter - Reliable (html2canvas + jsPDF)</title>
  <meta name="description" content="Convert HTML to PDF in the browser using html2canvas + jsPDF. Improved to avoid blank PDFs." />
  <link rel="icon" href="https://img.icons8.com/fluency/48/toolbox.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    /* Design matching your uploaded tools */
    :root{--bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;--primary:#22d3ee;--muted:#9fb3c8;--radius:12px}
    body.light{--bg:#f6f8fb;--text:#0b1220;--card:#ffffff;--border:#e6eefc;--primary:#0b74ff;--muted:#556677}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;transition:background .25s,color .25s}
    .container{max-width:1200px;margin:0 auto;padding:20px;width:100%}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border-bottom:1px solid var(--border);padding:14px 20px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:46px;height:46px;border-radius:10px}
    .brand .title{font-size:1.25rem;font-weight:700;color:var(--primary);margin:0}
    .brand .tag{font-size:.9rem;color:var(--muted)}
    .header-actions{display:flex;gap:10px;align-items:center}
    .btn-header{border:1px solid var(--border);background:transparent;padding:8px 12px;border-radius:8px;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;text-decoration:none;font-weight:600}
    .btn-header:hover{border-color:var(--primary);color:var(--primary)}

    .tool-content { background:var(--card);border-radius:var(--radius);border:1px solid var(--border);padding:22px;margin-top:20px; }
    .tool-title { font-size:1.6rem;margin-bottom:6px;color:var(--primary); }
    .tool-description { color:var(--muted);margin-bottom:16px; }

    .grid { display:grid; grid-template-columns: 1fr 420px; gap:16px; align-items:start; }
    @media (max-width:980px){ .grid { grid-template-columns: 1fr; } }

    .left-panel { display:flex;flex-direction:column;gap:12px; }
    .right-panel { display:flex;flex-direction:column;gap:12px; }

    .card { background:var(--bg); border:1px solid var(--border); padding:12px; border-radius:10px; }

    .controls-row { display:flex;gap:8px;align-items:center;flex-wrap:wrap; }
    .input, .select, .textarea, .file-input { background:var(--card); border:1px solid var(--border); padding:8px 10px; border-radius:8px; color:var(--text); outline:none; width:100% }
    .textarea { min-height:260px; resize:vertical; font-family:monospace; font-size:0.95rem; }
    .file-input { display:none; }
    .small { color:var(--muted); font-size:0.9rem; }

    .preview-frame { width:100%; height:640px; border-radius:8px; border:1px solid var(--border); background:#fff; overflow:auto; }
    .preview-wrap { min-height:320px; display:flex;flex-direction:column;gap:8px; align-items:stretch; }

    .btn { padding:10px 14px; border-radius:10px; border:none; font-weight:700; cursor:pointer; display:inline-flex; gap:8px; align-items:center; }
    .btn-primary { background:var(--primary); color:#00131f; }
    .btn-secondary { background:var(--card); border:1px solid var(--border); color:var(--text); }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }

    .options { display:flex;gap:10px;align-items:center;flex-wrap:wrap; }

    .status { margin-top:8px; color:var(--muted); font-size:0.9rem; }

    footer{margin-top:auto;padding:16px 0;background:var(--card);border-top:1px solid var(--border)}
    .footer-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .footer-links{display:flex;gap:14px;flex-wrap:wrap}
    .footer-links a{color:var(--primary);text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <header class="container">
    <div class="brand">
      <a href="index.html" style="display:flex;align-items:center;gap:12px;text-decoration:none;">
        <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="Smarttool Hub Logo">
        <div>
          <div class="title">Smarttool Hub</div>
          <div class="tag">Fast • Private • 100% Client-side</div>
        </div>
      </a>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn-header"><i class="fa-solid fa-house"></i> Home</a>
      <button class="btn-header" id="themeToggle" title="Toggle dark/light mode"><i class="fa-solid fa-moon"></i></button>
    </div>
  </header>

  <main class="container">
    <div class="tool-content">
      <h1 class="tool-title">HTML → PDF Converter (Reliable)</h1>
      <p class="tool-description">Paste HTML or upload an .html file, preview it, then convert the rendered output to PDF using html2canvas + jsPDF. This approach reduces blank PDF issues.</p>

      <div class="grid">
        <!-- LEFT: HTML editor & controls -->
        <div class="left-panel">
          <div class="card">
            <div style="display:flex;gap:8px;align-items:center;">
              <strong>Input HTML</strong>
              <div class="small" style="margin-left:auto">Paste HTML or upload a .html file</div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
              <label for="htmlFile" class="btn btn-secondary" style="cursor:pointer"><i class="fa-solid fa-upload"></i> Upload HTML</label>
              <input id="htmlFile" class="file-input" type="file" accept=".html,.htm,text/html">
              <button id="loadToPreview" class="btn btn-secondary"><i class="fa-solid fa-eye"></i> Load Preview</button>
              <button id="clearHtml" class="btn btn-secondary"><i class="fa-solid fa-trash"></i> Clear</button>
            </div>

            <div style="margin-top:12px;">
              <textarea id="htmlInput" class="textarea" placeholder="Paste HTML here...">&lt;!doctype html&gt;
&lt;html&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;title&gt;Example&lt;/title&gt;&lt;style&gt;body{font-family:system-ui,Arial;color:#111;padding:20px;}h1{color:#0b74ff}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Hello — test PDF&lt;/h1&gt;&lt;p&gt;If this shows in preview, it should appear in PDF.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</textarea>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <div class="options" style="align-items:center;">
                <label class="small">Page size</label>
                <select id="pageSize" class="select" style="width:110px">
                  <option value="a4" selected>A4</option>
                  <option value="letter">Letter</option>
                  <option value="a3">A3</option>
                </select>
              </div>

              <div class="options">
                <label class="small">Orientation</label>
                <select id="orientation" class="select" style="width:110px">
                  <option value="portrait" selected>Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>

              <div class="options">
                <label class="small">Margin (mm)</label>
                <input id="marginMM" class="input" type="number" min="0" max="40" value="10" style="width:80px">
              </div>

              <div class="options">
                <label class="small">Scale (canvas)</label>
                <input id="scale" class="input" type="number" min="1" max="3" step="0.1" value="2" style="width:80px">
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
              <button id="generatePdfBtn" class="btn btn-primary"><i class="fa-solid fa-file-pdf"></i> Generate PDF</button>
              <button id="downloadPdfBtn" class="btn btn-secondary" disabled><i class="fa-solid fa-download"></i> Download Last PDF</button>
              <button id="openNewTabBtn" class="btn btn-secondary" disabled><i class="fa-solid fa-up-right-from-square"></i> Open PDF</button>
              <div style="margin-left:auto;color:var(--muted);font-weight:700" id="summaryText">Ready</div>
            </div>

            <div class="status" id="statusText">Tip: Inline CSS and images with CORS enabled work best. If preview looks right but PDF is blank, check console for errors.</div>
          </div>

          <div class="card small">
            <strong>Notes & debugging</strong>
            <ul style="margin-top:8px;line-height:1.5;color:var(--muted)">
              <li>Make sure the preview shows the content (Load Preview).</li>
              <li>External images require CORS (Access-Control-Allow-Origin) to be rendered by html2canvas.</li>
              <li>Open DevTools → Console to see errors if PDF is blank.</li>
            </ul>
          </div>
        </div>

        <!-- RIGHT: Preview + output -->
        <div class="right-panel">
          <div class="card preview-wrap">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>Preview</strong>
              <div class="small">Rendered HTML — what will be captured</div>
            </div>
            <iframe id="previewFrame" class="preview-frame" sandbox="allow-same-origin allow-scripts"></iframe>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="refreshPreviewBtn" class="btn btn-secondary"><i class="fa-solid fa-arrows-rotate"></i> Refresh Preview</button>
              <button id="printPreviewBtn" class="btn btn-secondary"><i class="fa-solid fa-print"></i> Print Preview</button>
              <button id="downloadHtmlBtn" class="btn btn-secondary"><i class="fa-solid fa-file-code"></i> Download HTML</button>
            </div>
          </div>

          <div class="card">
            <strong>Last Output</strong>
            <div id="lastOutputInfo" style="margin-top:8px;color:var(--muted)">No PDF generated yet.</div>
            <div style="margin-top:10px;display:flex;gap:8px">
              <button id="clearOutputBtn" class="btn btn-secondary" disabled><i class="fa-solid fa-trash"></i> Clear Output</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <footer class="container">
    <div class="footer-inner">
      <div>© <span id="year"></span> Smarttool Hub</div>
      <div class="footer-links">
        <a href="privacy.html">Privacy</a>
        <a href="terms.html">Terms</a>
        <a href="contact.html">Contact</a>
      </div>
    </div>
  </footer>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // UI & theme
    document.getElementById('year').textContent = new Date().getFullYear();
    const themeToggle = document.getElementById('themeToggle');
    if (localStorage.getItem('sth_theme') === 'light') { document.body.classList.add('light'); themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>'; }
    themeToggle.onclick = () => {
      document.body.classList.toggle('light');
      if (document.body.classList.contains('light')) { themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>'; localStorage.setItem('sth_theme','light'); }
      else { themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>'; localStorage.removeItem('sth_theme'); }
    };

    // elements
    const htmlInput = document.getElementById('htmlInput');
    const htmlFile = document.getElementById('htmlFile');
    const loadToPreview = document.getElementById('loadToPreview');
    const previewFrame = document.getElementById('previewFrame');
    const refreshPreviewBtn = document.getElementById('refreshPreviewBtn');
    const printPreviewBtn = document.getElementById('printPreviewBtn');
    const downloadHtmlBtn = document.getElementById('downloadHtmlBtn');

    const pageSize = document.getElementById('pageSize');
    const orientation = document.getElementById('orientation');
    const marginMM = document.getElementById('marginMM');
    const scale = document.getElementById('scale');

    const generatePdfBtn = document.getElementById('generatePdfBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const openNewTabBtn = document.getElementById('openNewTabBtn');
    const clearHtmlBtn = document.getElementById('clearHtml');
    const clearOutputBtn = document.getElementById('clearOutputBtn');

    const statusText = document.getElementById('statusText');
    const lastOutputInfo = document.getElementById('lastOutputInfo');
    const summaryText = document.getElementById('summaryText');

    let lastPdfBlob = null;
    let lastPdfUrl = null;

    // helpers
    function showStatus(msg, timeout=4000) {
      statusText.textContent = msg;
      if (timeout) setTimeout(()=> { statusText.textContent = 'Tip: Inline CSS and images with CORS enabled work best.'; }, timeout);
    }
    function formatFileSize(bytes){ return bytes ? Math.round(bytes/1024) + ' KB' : '0 KB'; }

    // file upload
    htmlFile.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try {
        const text = await f.text();
        htmlInput.value = text;
        showStatus('HTML file loaded into editor');
      } catch (err) {
        console.error('Failed to read file', err);
        showStatus('Failed to read HTML file', 4000);
      } finally {
        htmlFile.value = '';
      }
    });

    // preview load
    async function loadPreview() {
      const html = htmlInput.value || '<p style="padding:20px">No HTML provided</p>';
      // Use srcdoc -> same-origin so html2canvas can access DOM
      previewFrame.srcdoc = html;
      await waitForIframeLoad(previewFrame, 1500);
      showStatus('Preview loaded. If images are missing, CORS may block them.');
    }
    loadToPreview.addEventListener('click', loadPreview);

    refreshPreviewBtn.addEventListener('click', async () => {
      const doc = previewFrame.srcdoc;
      previewFrame.srcdoc = '';
      setTimeout(()=> { previewFrame.srcdoc = doc; }, 40);
      await waitForIframeLoad(previewFrame, 1500);
      showStatus('Preview refreshed');
    });

    printPreviewBtn.addEventListener('click', () => {
      try {
        previewFrame.contentWindow.focus();
        previewFrame.contentWindow.print();
      } catch (err) {
        const w = window.open();
        w.document.open();
        w.document.write(htmlInput.value || '<p>No preview</p>');
        w.document.close();
        w.focus();
        setTimeout(()=> w.print(), 500);
      }
    });

    downloadHtmlBtn.addEventListener('click', () => {
      const blob = new Blob([htmlInput.value || ''], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `exported_html_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.html`; document.body.appendChild(a); a.click();
      setTimeout(()=> { URL.revokeObjectURL(url); try{document.body.removeChild(a);}catch(e){} }, 400);
    });

    clearHtmlBtn.addEventListener('click', () => {
      htmlInput.value = '';
      previewFrame.srcdoc = '';
      showStatus('Editor cleared');
    });

    // wait for iframe load
    function waitForIframeLoad(iframe, timeout=2000) {
      return new Promise((resolve) => {
        let done = false;
        function finish(){ if(!done){ done=true; resolve(); } }
        try {
          const doc = iframe.contentDocument;
          if (doc && (doc.readyState === 'complete' || doc.readyState === 'interactive')) return finish();
        } catch(e){}
        const t = setTimeout(()=> { iframe.removeEventListener('load', onload); finish(); }, timeout);
        function onload(){ clearTimeout(t); iframe.removeEventListener('load', onload); finish(); }
        iframe.addEventListener('load', onload);
      });
    }

    // Core: capture preview iframe body with html2canvas then create PDF with jsPDF
    generatePdfBtn.addEventListener('click', async () => {
      // ensure preview loaded
      if (!previewFrame.srcdoc || previewFrame.srcdoc.trim() === '') {
        await loadPreview();
      } else {
        await waitForIframeLoad(previewFrame, 1200);
      }

      // get iframe document body
      let targetBody;
      try {
        targetBody = previewFrame.contentDocument.body;
        if (!targetBody) throw new Error('iframe body not accessible');
      } catch (err) {
        console.error('Cannot access iframe body (same-origin issue?)', err);
        showStatus('Cannot access preview DOM. Ensure preview was loaded via "Load Preview" and not blocked by cross-origin restrictions.', 8000);
        return;
      }

      // build an offscreen clone container to give html2canvas consistent measurement (and white background)
      const clone = targetBody.cloneNode(true);
      const off = document.createElement('div');
      off.style.position = 'fixed';
      off.style.left = '-9999px';
      off.style.top = '-9999px';
      off.style.width = (previewFrame.clientWidth || 900) + 'px';
      off.style.background = '#ffffff';
      off.style.padding = '0';
      off.appendChild(clone);
      document.body.appendChild(off);

      // optionally inject base tag to help relative urls (use current location)
      try {
        const base = document.createElement('base');
        base.href = window.location.href;
        const head = clone.ownerDocument && clone.ownerDocument.querySelector ? clone.ownerDocument.querySelector('head') : null;
        // if clone contains head, insert base; otherwise set no-op (not critical)
        // (we can't reliably access clone's head when cloning body-only; so we skip if not present)
        // NOTE: relative resources may still fail due to CORS or origin mismatch
      } catch (e){ /* ignore */ }

      // capture with html2canvas
      const scaleVal = Math.max(1, Math.min(3, Number(scale.value) || 2));
      showStatus('Capturing preview to image — please wait...', 10000);
      generatePdfBtn.disabled = true;
      summaryText.textContent = 'Capturing...';
      let canvas;
      try {
        canvas = await html2canvas(clone, {
          scale: scaleVal,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          windowWidth: previewFrame.clientWidth || 1000,
        });
      } catch (err) {
        console.error('html2canvas failed', err);
        showStatus('Rendering failed (see console). Try simpler HTML or inline images.', 8000);
        generatePdfBtn.disabled = false;
        off.remove();
        return;
      }

      // convert canvas -> image data
      const imgData = canvas.toDataURL('image/jpeg', 0.95);

      // create jsPDF document and split into pages if needed
      try {
        const { jsPDF } = window.jspdf;
        const format = pageSize.value || 'a4';
        const orient = orientation.value || 'portrait';
        const margin = Number(marginMM.value) || 10; // mm
        // page dimensions in mm (approx)
        const pageDims = (formatName, orientationVal) => {
          // mm sizes for common formats (portrait)
          const sizes = { a4: {w:210,h:297}, letter: {w:216,h:279}, a3: {w:297,h:420} };
          let s = sizes[formatName] || sizes.a4;
          if (orientationVal === 'landscape') return { w: s.h, h: s.w };
          return s;
        };
        const dims = pageDims(format, orient);
        // convert mm to px at 96dpi: px = mm * 96 / 25.4
        const mmToPx = mm => mm * 96 / 25.4;
        const pageWpx = mmToPx(dims.w - margin*2);
        const pageHpx = mmToPx(dims.h - margin*2);

        // But our canvas is in px (scaled). We'll slice canvas vertically into page-sized pieces based on pageHpx.
        const canvasW = canvas.width;
        const canvasH = canvas.height;
        // scale factor between canvas px and pdf mm units
        // when adding image to jsPDF, we give width/height in mm. We'll compute image width in mm for the page content area:
        const contentWidthMM = dims.w - margin*2;
        const contentHeightMM = dims.h - margin*2;

        // compute corresponding image width in px for content width
        const imgWidthPxForContent = (canvasW / canvasW) * canvasW; // simply canvasW
        // We'll scale each slice proportionally: image slice height in px corresponding to pageHeightMM:
        const ratio = canvasW / contentWidthMM; // px per mm (approx)
        // sliceHeight in px = contentHeightMM * ratio
        const sliceHeightPx = Math.round(contentHeightMM * ratio);

        // create jsPDF
        const doc = new jsPDF({ unit: 'mm', format: [dims.w, dims.h], orientation: orient });

        let yPosPx = 0;
        let pageIndex = 0;
        while (yPosPx < canvasH) {
          pageIndex++;
          // create slice canvas
          const sliceCanvas = document.createElement('canvas');
          sliceCanvas.width = canvasW;
          sliceCanvas.height = Math.min(sliceHeightPx, canvasH - yPosPx);
          const sctx = sliceCanvas.getContext('2d');
          sctx.fillStyle = '#fff';
          sctx.fillRect(0,0,sliceCanvas.width,sliceCanvas.height);
          sctx.drawImage(canvas, 0, yPosPx, canvasW, sliceCanvas.height, 0, 0, canvasW, sliceCanvas.height);

          const sliceData = sliceCanvas.toDataURL('image/jpeg', 0.95);
          // compute image height in mm for jsPDF: heightMM = (sliceCanvas.height / canvasW) * contentWidthMM
          const heightMM = (sliceCanvas.height * contentWidthMM) / canvasW;

          const xMM = margin;
          const yMM = margin;

          if (pageIndex > 1) doc.addPage();
          doc.addImage(sliceData, 'JPEG', xMM, yMM, contentWidthMM, heightMM);

          yPosPx += sliceCanvas.height;
        }

        // output as blob
        const arrayBuf = doc.output('arraybuffer');
        const pdfBlob = new Blob([arrayBuf], { type: 'application/pdf' });
        if (lastPdfUrl) { URL.revokeObjectURL(lastPdfUrl); lastPdfUrl = null; }
        lastPdfBlob = pdfBlob;
        lastPdfUrl = URL.createObjectURL(pdfBlob);
        downloadPdfBtn.disabled = false;
        openNewTabBtn.disabled = false;
        clearOutputBtn.disabled = false;
        lastOutputInfo.textContent = `Last PDF ready — ${formatFileSize(pdfBlob.size)}`;
        summaryText.textContent = 'PDF ready';
        showStatus('PDF generated successfully.');
      } catch (err) {
        console.error('jsPDF processing failed', err);
        showStatus('Failed to assemble PDF (see console).', 8000);
      } finally {
        generatePdfBtn.disabled = false;
        try { off.remove(); } catch(e){}
      }
    });

    // download / open handlers
    downloadPdfBtn.addEventListener('click', () => {
      if (!lastPdfBlob) { showStatus('No PDF available to download'); return; }
      const url = lastPdfUrl || URL.createObjectURL(lastPdfBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `html_export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;
      document.body.appendChild(a); a.click();
      setTimeout(()=> { try{ document.body.removeChild(a); }catch(e){} }, 300);
    });

    openNewTabBtn.addEventListener('click', () => {
      if (!lastPdfUrl) { showStatus('No PDF to open'); return; }
      window.open(lastPdfUrl, '_blank');
    });

    clearOutputBtn.addEventListener('click', () => {
      if (lastPdfUrl) { URL.revokeObjectURL(lastPdfUrl); lastPdfUrl = null; }
      lastPdfBlob = null;
      lastOutputInfo.textContent = 'No PDF generated yet.';
      downloadPdfBtn.disabled = true;
      openNewTabBtn.disabled = true;
      clearOutputBtn.disabled = true;
      showStatus('Last output cleared');
    });

    // init: load preview sample
    (function init(){ loadPreview().catch(()=>{}); })();
  </script>
</body>
</html>
