<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compress PDF — Smarttool Hub</title>
  <meta name="description" content="Compress PDF files client-side. Reduce PDF size by rasterizing pages to JPEG with adjustable quality and downscale. 100% client-side, drag & drop, preview & download." />
  <meta name="keywords" content="compress pdf, reduce pdf size, pdf compressor, compress pdf online, shrink pdf, pdf optimization" />
  <link rel="icon" href="https://img.icons8.com/fluency/48/toolbox.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root{--bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;--primary:#22d3ee;--muted:#9fb3c8}
    body.light{--bg:#f6f8fb;--text:#0b1220;--card:#fff;--border:#e6eefc;--primary:#0b74ff;--muted:#556677}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text);transition:.22s}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;background:var(--card);padding:12px;border-bottom:1px solid var(--border)}
    .brand a{display:flex;gap:12px;align-items:center;text-decoration:none;color:inherit}
    .brand img{width:46px;height:46px;border-radius:8px}
    .title{font-weight:700;color:var(--primary)}
    .tag{font-size:.85rem;color:var(--muted)}
    .header-actions{display:flex;gap:8px;align-items:center}
    .btn-header{border:1px solid var(--border);background:transparent;padding:8px 12px;border-radius:8px;color:var(--text);cursor:pointer;display:flex;gap:8px;align-items:center;text-decoration:none;font-weight:600}
    main{padding:18px 0}
    h1{margin:6px 0 8px;color:var(--primary)}
    .meta{color:var(--muted);margin-bottom:12px}
    .uploader{min-height:110px;border-radius:12px;border:2px dashed var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;background:var(--card);cursor:pointer}
    .uploader:hover{border-color:var(--primary)}
    input[type=file]{display:none}
    .controls{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .controls label{font-size:.9rem;color:var(--muted);display:block}
    .controls input[type=range], .controls input[type=number], .controls select { padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text) }
    .preview-info{margin-top:12px;color:var(--muted)}
    .progress{height:12px;background:var(--border);border-radius:999px;overflow:hidden;margin-top:12px}
    .progress-bar{height:100%;width:0;background:var(--primary);transition:width .2s}
    .actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#00131f}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .status{color:var(--muted);display:flex;align-items:center;gap:8px}
    .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--primary);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    footer{margin-top:24px;padding:12px 0;background:var(--card);border-top:1px solid var(--border)}
    @media(max-width:820px){.controls{flex-direction:column;align-items:flex-start}}
    .small{font-size:.9rem;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="container">
    <div class="brand">
      <a href="../../index.html" title="Back to Smarttool Hub">
        <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="Smarttool Hub logo">
        <div>
          <div class="title">Smarttool Hub</div>
          <div class="tag">Fast • Private • Client-side</div>
        </div>
      </a>
    </div>
    <div class="header-actions">
      <a href="../../index.html" class="btn-header"><i class="fa-solid fa-house"></i> Home</a>
      <button id="themeToggle" class="btn-header" title="Toggle theme"><i class="fa-solid fa-moon"></i></button>
    </div>
  </header>

  <main class="container">
    <h1>Compress PDF</h1>
    <p class="meta">Reduce PDF file size by rasterizing each page to JPEG with configurable quality and downscale. Best for scanned/image PDFs. This runs fully in your browser — files are not uploaded.</p>

    <label class="uploader" id="uploader">
      <div style="font-size:28px;color:var(--primary)"><i class="fa-solid fa-compress"></i></div>
      <div style="margin-top:8px;font-weight:700">Click or drag & drop a PDF</div>
      <div style="margin-top:6px;color:var(--muted)">Supported: .pdf — single file at a time.</div>
      <input type="file" id="fileInput" accept="application/pdf" />
    </label>

    <div class="controls" aria-label="compression settings">
      <div>
        <label for="quality">JPEG Quality: <span id="qualityLabel">0.7</span></label>
        <input id="quality" type="range" min="0.1" max="1" step="0.05" value="0.7">
      </div>

      <div>
        <label for="maxWidth">Max width (px, 0 = no downscale)</label>
        <input id="maxWidth" type="number" class="small" min="0" value="1200">
      </div>

      <div>
        <label for="renderScale">Render scale (1.0 = native, higher = better quality)</label>
        <select id="renderScale" class="small">
          <option value="1.0">1.0</option>
          <option value="1.2">1.2</option>
          <option value="1.5" selected>1.5</option>
          <option value="2.0">2.0</option>
        </select>
      </div>

      <div>
        <label for="preserveText">Preserve vector/text (try)</label>
        <select id="preserveText" class="small">
          <option value="auto" selected>Auto (attempt vector copy if no transforms)</option>
          <option value="always">Always (try vector copy)</option>
          <option value="never">Never (force raster)</option>
        </select>
      </div>
    </div>

    <div class="preview-info" id="previewInfo">No PDF loaded.</div>

    <div class="progress" aria-hidden="true"><div class="progress-bar" id="progressBar"></div></div>

    <div class="actions">
      <button id="compressBtn" class="btn btn-primary" disabled><i class="fa-solid fa-floppy-disk"></i> Compress & Download</button>
      <button id="zipBtn" class="btn btn-ghost" disabled><i class="fa-solid fa-file-zipper"></i> Download pages as ZIP</button>
      <button id="clearBtn" class="btn btn-ghost" disabled><i class="fa-solid fa-trash-can"></i> Clear</button>
      <div class="status" id="status"></div>
    </div>

    <section style="margin-top:18px">
      <h2 style="color:var(--primary)">How it works</h2>
      <ol>
        <li>Upload a PDF.</li>
        <li>Choose JPEG quality and max width (downscale) — lower quality → smaller file.</li>
        <li>Click <strong>Compress & Download</strong> to create a compressed PDF (pages are images).</li>
      </ol>
      <p style="color:var(--muted)">Tip: select a lower quality for scanned PDFs to get significant savings. If you need selectable text preserved, try "Preserve vector/text: Auto" — the tool will attempt to copy pages directly (vector) when possible; otherwise it falls back to raster compression.</p>
    </section>
  </main>

  <footer class="container">
    <div>© <span id="year"></span> Smarttool Hub</div>
    <div style="color:var(--muted)">Privacy • Terms • Contact</div>
  </footer>

  <!-- FAQ JSON-LD -->
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"Does this tool upload my files?","acceptedAnswer":{"@type":"Answer","text":"No. All processing happens in your browser. Files are never uploaded."}},{"@type":"Question","name":"Will my text stay selectable?","acceptedAnswer":{"@type":"Answer","text":"If you choose raster compression, pages become images and text is not selectable. Use the preserve-vector option to attempt vector copying when possible."}}]}
  </script>

  <!-- Libraries: pdf.js to render, pdf-lib to build output, jszip for zip option -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
  (function(){
    // ---------- Theme + year ----------
    const themeBtn = document.getElementById('themeToggle');
    if(localStorage.getItem('sth_theme') === 'light'){ document.body.classList.add('light'); themeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>'; }
    themeBtn.addEventListener('click', ()=> {
      document.body.classList.toggle('light');
      if(document.body.classList.contains('light')){ themeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>'; localStorage.setItem('sth_theme','light'); }
      else { themeBtn.innerHTML = '<i class="fa-solid fa-moon"></i>'; localStorage.removeItem('sth_theme'); }
    });
    document.getElementById('year').textContent = new Date().getFullYear();

    // ---------- DOM refs ----------
    const uploader = document.getElementById('uploader');
    const fileInput = document.getElementById('fileInput');
    const previewInfo = document.getElementById('previewInfo');
    const progressBar = document.getElementById('progressBar');
    const statusEl = document.getElementById('status');

    const qualityEl = document.getElementById('quality');
    const qualityLabel = document.getElementById('qualityLabel');
    const maxWidthEl = document.getElementById('maxWidth');
    const renderScaleEl = document.getElementById('renderScale');
    const preserveTextEl = document.getElementById('preserveText');

    const compressBtn = document.getElementById('compressBtn');
    const zipBtn = document.getElementById('zipBtn');
    const clearBtn = document.getElementById('clearBtn');

    // ---------- state ----------
    // pdfData: { arrayBuffer, pdfjsDoc, pageCount, fileName }
    let pdfData = null;

    // ---------- helpers ----------
    function showStatus(txt, busy=false, hideMs=0){
      statusEl.textContent = txt || '';
      if(busy) statusEl.insertAdjacentHTML('afterbegin','<span class="spinner" aria-hidden="true"></span>');
      if(hideMs) setTimeout(()=> statusEl.textContent = '', hideMs);
    }
    function setProgress(p){ progressBar.style.width = Math.min(100,Math.max(0,Math.round(p))) + '%'; }
    function resetProgress(){ progressBar.style.width = '0%'; }
    function sanitize(name){ return name.replace(/[^a-z0-9_\-\.]/gi, '_'); }
    function triggerDownload(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(a.href), 3000);
    }

    // ---------- file input & drag/drop ----------
    uploader.addEventListener('click', ()=> fileInput.click());
    uploader.addEventListener('dragover', e => { e.preventDefault(); uploader.style.borderColor = 'var(--primary)'; });
    uploader.addEventListener('dragleave', e => { uploader.style.borderColor = ''; });
    uploader.addEventListener('drop', e => { e.preventDefault(); uploader.style.borderColor = ''; handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

    async function handleFile(file){
      if(!file) return;
      if(!(file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'))){
        alert('Please select a PDF file.');
        return;
      }
      showStatus('Loading PDF...', true);
      resetProgress();
      try{
        const buffer = await file.arrayBuffer();
        // attempt to load pdf.js doc (handles many PDFs and password detection)
        let pdfjsDoc = null;
        try {
          pdfjsDoc = await pdfjsLib.getDocument({ data: buffer }).promise;
        } catch(err){
          // if password-protected or other error, show message
          console.error('pdf.js load error', err);
          showStatus('Failed to read PDF. It may be password-protected or corrupted.', false);
          return;
        }
        pdfData = { arrayBuffer: buffer, pdfjsDoc, pageCount: pdfjsDoc.numPages, fileName: file.name };
        previewInfo.textContent = `${file.name} — ${pdfData.pageCount} pages loaded.`;
        showStatus('PDF ready', false, 1800);
        compressBtn.disabled = false;
        zipBtn.disabled = false;
        clearBtn.disabled = false;
      } catch(err){
        console.error(err);
        showStatus('Failed to read file — see console', false);
      }
    }

    // ---------- UI helpers ----------
    qualityEl.addEventListener('input', ()=> qualityLabel.textContent = qualityEl.value);
    clearBtn.addEventListener('click', ()=> {
      if(pdfData && pdfData.pdfjsDoc) try{ pdfData.pdfjsDoc.destroy(); }catch(e){}
      pdfData = null;
      previewInfo.textContent = 'No PDF loaded.';
      compressBtn.disabled = true;
      zipBtn.disabled = true;
      clearBtn.disabled = true;
      resetProgress();
      showStatus('', false);
    });

    // ---------- compress logic ----------
    // Two strategies:
    // 1) If preserveText == 'always' or 'auto' and the PDF has no transforms applied (we do a quick pdf-lib load), try a vector-copy approach:
    //    - Load pdf-lib and copy pages into a new doc WITHOUT rasterizing (this doesn't reduce embedded image quality).
    //    - If the original has large images, this often doesn't reduce size. So we fallback to rasterize approach below which re-encodes pages as JPEGs.
    // 2) Rasterize each page with pdf.js at selected renderScale, downscale to maxWidth if requested, convert to JPEG with chosen quality, embed into new PDF via pdf-lib.
    // We'll attempt vector copy only if user chooses preserveText 'always' or 'auto'. When 'auto' we try vector copy only if renderScale == 1 and no transforms requested.
    async function compressToPdf({ asZip = false } = {}) {
      if(!pdfData) return;
      const quality = Number(qualityEl.value) || 0.7;
      const maxWidth = Number(maxWidthEl.value) || 0;
      const renderScale = Number(renderScaleEl.value) || 1.5;
      const preserve = preserveTextEl.value; // 'auto'|'always'|'never'

      showStatus('Preparing compression...', true);
      setProgress(0);

      // If preserveText == 'always', attempt to use pdf-lib copy (no raster):
      if((preserve === 'always' || preserve === 'auto') && !asZip) {
        // try to use pdf-lib copyPages — this preserves vectors (no rasterization)
        // But pdf-lib won't reduce image sizes — only recompressing images would help.
        // We'll attempt to re-embed images with lower JPEG quality is non-trivial here.
        // So: if preserve == 'always' we try to copy pages directly and finish (this will likely not shrink much).
        if(preserve === 'always') {
          try {
            showStatus('Attempting vector copy (may preserve text) ...', true);
            const src = await PDFLib.PDFDocument.load(pdfData.arrayBuffer, { ignoreEncryption: true });
            const out = await PDFLib.PDFDocument.create();
            const count = src.getPageCount();
            for(let i=0;i<count;i++){
              const [pg] = await out.copyPages(src, [i]);
              out.addPage(pg);
              setProgress(((i+1)/count)*100);
              await new Promise(r=>setTimeout(r, 20));
            }
            const bytes = await out.save();
            triggerDownload(new Blob([bytes], { type: 'application/pdf' }), sanitize(pdfData.fileName).replace(/\.[^/.]+$/, '') + '_copied.pdf');
            showStatus('Vector copy complete (no raster). File may not be smaller.', false, 2200);
            setProgress(100);
            return;
          } catch(err){
            console.warn('Vector copy failed, falling back to raster compression', err);
          }
        }
      }

      // Rasterize approach (recommended): render pages with pdf.js, convert to JPEG, embed into new PDF
      try {
        const outPdf = await PDFLib.PDFDocument.create();
        const pageCount = pdfData.pageCount;
        for(let i=0;i<pageCount;i++){
          const pageNum = i + 1;
          showStatus(`Rendering page ${pageNum} of ${pageCount}...`, true);
          // render canvas using pdf.js
          const page = await pdfData.pdfjsDoc.getPage(pageNum);
          // chosen scale for rendering — use renderScale setting
          const viewport = page.getViewport({ scale: renderScale });
          // create an offscreen canvas sized to viewport
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(viewport.width);
          canvas.height = Math.round(viewport.height);
          const ctx = canvas.getContext('2d');
          // white background for better JPEG results
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0,0,canvas.width,canvas.height);
          await page.render({ canvasContext: ctx, viewport }).promise;

          // optionally downscale to maxWidth to reduce size
          let targetCanvas = canvas;
          if(maxWidth > 0 && canvas.width > maxWidth){
            const scale = maxWidth / canvas.width;
            const w = Math.round(canvas.width * scale);
            const h = Math.round(canvas.height * scale);
            const tmp = document.createElement('canvas');
            tmp.width = w; tmp.height = h;
            tmp.getContext('2d').drawImage(canvas, 0,0, canvas.width, canvas.height, 0,0, w, h);
            targetCanvas = tmp;
          }

          // convert canvas to JPEG blob with chosen quality
          const blob = await new Promise(res => targetCanvas.toBlob(res, 'image/jpeg', quality));
          const arr = await blob.arrayBuffer();
          // embed into PDF with pdf-lib
          const img = await outPdf.embedJpg(arr);
          const { width, height } = img.scale(1);
          const pageObj = outPdf.addPage([width, height]);
          pageObj.drawImage(img, { x:0, y:0, width, height });

          // progress
          setProgress(((i+1)/pageCount)*100);
          await new Promise(r=>setTimeout(r, 20));
        }

        // prepare output
        const bytes = await outPdf.save();
        if(asZip){
          // create per-page PDFs and zip
          const zip = new JSZip();
          // for separate pages, we already created outPdf with each page; but user may want each page separate.
          // We'll recreate per page PDFs by embedding single page images again.
          // Simpler: load again and split — but to avoid re-render, we will embed images from earlier step if stored.
          // For simplicity here we'll split from the saved bytes using pdf-lib: load and extract pages one-by-one.
          const mergedDoc = await PDFLib.PDFDocument.load(bytes);
          const total = mergedDoc.getPageCount();
          for(let p=0;p<total;p++){
            const single = await PDFLib.PDFDocument.create();
            const [copied] = await single.copyPages(mergedDoc, [p]);
            single.addPage(copied);
            const b = await single.save();
            zip.file(sanitize(pdfData.fileName).replace(/\.[^/.]+$/, '') + `_page_${p+1}.pdf`, b);
          }
          const blobZip = await zip.generateAsync({ type: 'blob' }, meta => setProgress(meta.percent));
          triggerDownload(blobZip, sanitize(pdfData.fileName).replace(/\.[^/.]+$/, '') + '_compressed_pages.zip');
          showStatus('ZIP ready ✓', false, 2200);
        } else {
          triggerDownload(new Blob([bytes], { type: 'application/pdf' }), sanitize(pdfData.fileName).replace(/\.[^/.]+$/, '') + '_compressed.pdf');
          showStatus('Compression complete ✓', false, 2200);
        }
      } catch(err){
        console.error('Compression failed', err);
        showStatus('Compression failed — see console', false);
      } finally {
        setTimeout(()=> resetProgress(), 800);
      }
    }

    // wire buttons
    compressBtn.addEventListener('click', ()=> compressToPdf({ asZip: false }));
    zipBtn.addEventListener('click', ()=> compressToPdf({ asZip: true }));

    // initial UI state
    qualityLabel.textContent = qualityEl.value;

    // expose small debugging helpers
    window._pdfData = () => pdfData;

  })();
  </script>
</body>
</html>
