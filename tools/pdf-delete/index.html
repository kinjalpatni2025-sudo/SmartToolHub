<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delete PDF Pages — Smarttool Hub</title>
  <link rel="icon" href="https://img.icons8.com/fluency/48/toolbox.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    :root{
      --bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;
      --primary:#22d3ee;--muted:#9fb3c8;--radius:12px;
    }
    body.light{
      --bg:#f6f8fb;--text:#0b1220;--card:#ffffff;--border:#e6eefc;
      --primary:#0b74ff;--muted:#556677;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Roboto,Arial;background:var(--bg);color:var(--text);
      min-height:100vh;display:flex;flex-direction:column;
    }
    .container{max-width:1200px;margin:0 auto;padding:20px;width:100%}
    header{display:flex;align-items:center;justify-content:space-between;background:var(--card);border-bottom:1px solid var(--border);padding:12px 20px;border-radius:10px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:46px;height:46px;border-radius:10px}
    .brand .title{font-size:1.15rem;font-weight:700;color:var(--primary)}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--primary);color:#00131f}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px}
    .tool-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-top:18px}
    .tool-title{font-size:1.4rem;color:var(--primary);margin:0 0 8px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input[type=file]{padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .files-section{margin-top:16px;display:flex;flex-direction:column;gap:16px}
    .file-block{border:1px solid var(--border);padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)}
    .file-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pages-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:12px}
    .page-item{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);text-align:center;background:rgba(255,255,255,0.01)}
    .page-item canvas{max-width:100%;height:auto;border-radius:6px;display:block;margin:0 auto 8px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
    .preview-block{margin-top:12px;padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,0.02)}
    iframe.preview{width:100%;height:420px;border:none;border-radius:6px}
    .small{font-size:.9rem}
    @media (max-width:720px){
      .pages-grid{grid-template-columns:repeat(2,1fr)}
      header{flex-direction:column;align-items:flex-start;gap:10px}
    }
  </style>
</head>
<body>
  <header class="container">
    <div class="brand">
      <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="logo">
      <div>
        <div class="title">Smarttool Hub</div>
        <div class="muted small">Delete PDF Pages</div>
      </div>
    </div>
    <div>
      <a href="../../index.html" class="btn-ghost"><i class="fa-solid fa-house"></i> Home</a>
    </div>
  </header>

  <main class="container">
    <div class="tool-card">
      <h2 class="tool-title">Delete PDF Pages (multi-file)</h2>
      <p class="muted">Select one or more PDF files. Thumbnails of every page will appear — tick pages you want to remove. Click <strong>Delete Selected Pages</strong> to create edited PDFs for each file. Preview & download each edited file below.</p>

      <div class="row">
        <label style="display:flex;gap:8px;align-items:center;">
          <input id="fileInput" type="file" accept="application/pdf" multiple />
        </label>
        <button id="loadBtn" class="btn btn-primary"><i class="fa-solid fa-file-import"></i> Load Files</button>
        <button id="clearBtn" class="btn btn-ghost"><i class="fa-solid fa-trash-arrow-up"></i> Clear</button>
      </div>

      <div class="files-section" id="filesSection"></div>

      <div class="controls">
        <button id="deleteBtn" class="btn btn-primary" disabled><i class="fa-solid fa-trash"></i> Delete Selected Pages</button>
        <button id="downloadAllBtn" class="btn btn-ghost" disabled><i class="fa-solid fa-download"></i> Download All Edited</button>
      </div>

      <div id="globalStatus" class="muted small" style="margin-top:10px"></div>

      <div id="editedPreviews" style="margin-top:16px"></div>
    </div>
  </main>

  <footer class="container" style="margin-top:20px;padding:12px 0;color:var(--muted)">
    © <span id="year"></span> Smarttool Hub
  </footer>

  <!-- Libraries -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
    // Basic DOM
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const filesSection = document.getElementById('filesSection');
    const deleteBtn = document.getElementById('deleteBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const globalStatus = document.getElementById('globalStatus');
    const editedPreviews = document.getElementById('editedPreviews');
    document.getElementById('year').textContent = new Date().getFullYear();

    // State: array of objects per file
    // { file, arrayBuffer, pdfDoc(lib), pdfjsDoc, pageCount, deletedPages:Set<number>, editedBlob, editedUrl }
    let filesState = [];

    // Configure pdf.js worker (uses built-in worker from CDN)
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    function setGlobalStatus(msg, isError=false){
      globalStatus.textContent = msg;
      globalStatus.style.color = isError ? '#ff8a8a' : '';
    }

    clearBtn.onclick = () => {
      filesState.forEach(f => {
        if (f.editedUrl) URL.revokeObjectURL(f.editedUrl);
      });
      filesState = [];
      filesSection.innerHTML = '';
      editedPreviews.innerHTML = '';
      deleteBtn.disabled = true;
      downloadAllBtn.disabled = true;
      setGlobalStatus('');
      fileInput.value = '';
    };

    loadBtn.onclick = async () => {
      setGlobalStatus('');
      filesSection.innerHTML = '';
      editedPreviews.innerHTML = '';
      filesState.forEach(f => { if (f.editedUrl) URL.revokeObjectURL(f.editedUrl); });
      filesState = [];

      const fileList = Array.from(fileInput.files || []);
      if (fileList.length === 0) { setGlobalStatus('Please select one or more PDF files.'); return; }

      setGlobalStatus('Loading files — rendering thumbnails (this may take a while for large PDFs)...');
      loadBtn.disabled = true;
      clearBtn.disabled = true;

      for (let i = 0; i < fileList.length; i++) {
        const file = fileList[i];
        try {
          const arrayBuffer = await file.arrayBuffer();
          // pdf-lib load (for editing)
          const pdfLibDoc = await PDFLib.PDFDocument.load(new Uint8Array(arrayBuffer));
          // pdf.js load (for rendering thumbnails)
          const pdfjsDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
          const pageCount = pdfjsDoc.numPages;

          const fileState = {
            file,
            arrayBuffer,
            pdfLibDoc,
            pdfjsDoc,
            pageCount,
            deletedPages: new Set(),
            editedBlob: null,
            editedUrl: null
          };
          filesState.push(fileState);

          // Render UI block for this file
          const block = document.createElement('div');
          block.className = 'file-block';
          block.dataset.fileIndex = i;

          const header = document.createElement('div');
          header.className = 'file-header';
          header.innerHTML = `<div><strong>${escapeHtml(file.name)}</strong> — <span class="muted small">${pageCount} pages</span></div>
                              <div>
                                <button class="btn btn-ghost btn-select-all small">Select All</button>
                                <button class="btn btn-ghost btn-deselect-all small">Deselect All</button>
                              </div>`;
          block.appendChild(header);

          const pagesGrid = document.createElement('div');
          pagesGrid.className = 'pages-grid';
          pagesGrid.setAttribute('aria-label', `Pages for ${file.name}`);

          // Render each page thumbnail
          for (let p = 1; p <= pageCount; p++) {
            const page = await pdfjsDoc.getPage(p);
            const viewport = page.getViewport({ scale: 0.5 });
            const canvas = document.createElement('canvas');
            canvas.width = Math.floor(viewport.width);
            canvas.height = Math.floor(viewport.height);
            const ctx = canvas.getContext('2d');

            // Render page into canvas
            await page.render({ canvasContext: ctx, viewport }).promise;

            const pageItem = document.createElement('div');
            pageItem.className = 'page-item';
            pageItem.innerHTML = `
              <div style="min-height:1px"></div>
              <label style="cursor:pointer;display:block">
                <div style="display:flex;justify-content:center;margin-bottom:6px"></div>
                <input type="checkbox" data-file-index="${filesState.length - 1}" data-page-index="${p - 1}"> Page ${p}
              </label>
            `;
            pageItem.querySelector('div').appendChild(canvas);

            // Double-click toggles checkbox
            pageItem.addEventListener('dblclick', (e) => {
              const cb = pageItem.querySelector('input[type=checkbox]');
              cb.checked = !cb.checked;
              // update deletedPages set
              const fi = parseInt(cb.dataset.fileIndex,10);
              const pi = parseInt(cb.dataset.pageIndex,10);
              updateDeletedSet(fi, pi, cb.checked);
            });

            // Checkbox change updates set
            pageItem.querySelector('input[type=checkbox]').addEventListener('change', (ev) => {
              const cb = ev.target;
              const fi = parseInt(cb.dataset.fileIndex,10);
              const pi = parseInt(cb.dataset.pageIndex,10);
              updateDeletedSet(fi, pi, cb.checked);
            });

            pagesGrid.appendChild(pageItem);
          }

          // Select/Deselect all buttons
          header.querySelector('.btn-select-all').addEventListener('click', () => {
            pagesGrid.querySelectorAll('input[type=checkbox]').forEach(cb => {
              cb.checked = true;
              const fi = parseInt(cb.dataset.fileIndex,10);
              const pi = parseInt(cb.dataset.pageIndex,10);
              updateDeletedSet(fi, pi, true);
            });
          });
          header.querySelector('.btn-deselect-all').addEventListener('click', () => {
            pagesGrid.querySelectorAll('input[type=checkbox]').forEach(cb => {
              cb.checked = false;
              const fi = parseInt(cb.dataset.fileIndex,10);
              const pi = parseInt(cb.dataset.pageIndex,10);
              updateDeletedSet(fi, pi, false);
            });
          });

          block.appendChild(pagesGrid);
          filesSection.appendChild(block);

        } catch (err) {
          console.error('Error loading file', file.name, err);
          const errBlock = document.createElement('div');
          errBlock.className = 'file-block';
          errBlock.innerHTML = `<strong>${escapeHtml(file.name)}</strong> — <span class="muted">Failed to load (possibly encrypted or corrupted)</span>`;
          filesSection.appendChild(errBlock);
        }
      } // end for files

      loadBtn.disabled = false;
      clearBtn.disabled = false;

      if (filesState.length > 0) {
        deleteBtn.disabled = false;
        setGlobalStatus(`Loaded ${filesState.length} file(s). Select pages to delete, then click "Delete Selected Pages".`);
      } else {
        setGlobalStatus('No files loaded.');
      }
    };

    function updateDeletedSet(fileIndex, pageIndex, checked) {
      const state = filesState[fileIndex];
      if (!state) return;
      if (checked) state.deletedPages.add(pageIndex);
      else state.deletedPages.delete(pageIndex);

      // Enable/disable global actions
      const anyDeletion = filesState.some(f => f.deletedPages.size > 0);
      deleteBtn.disabled = !anyDeletion;
    }

    // Delete selected pages (process all files)
    deleteBtn.onclick = async () => {
      setGlobalStatus('Creating edited PDFs — please wait...');
      deleteBtn.disabled = true;
      loadBtn.disabled = true;
      clearBtn.disabled = true;
      downloadAllBtn.disabled = true;
      editedPreviews.innerHTML = '';

      for (let fi = 0; fi < filesState.length; fi++) {
        const f = filesState[fi];
        try {
          const keepPages = [];
          for (let p = 0; p < f.pageCount; p++) {
            if (!f.deletedPages.has(p)) keepPages.push(p);
          }

          const newPdf = await PDFLib.PDFDocument.create();

          if (keepPages.length > 0) {
            // copy selected pages from original
            const copied = await newPdf.copyPages(f.pdfLibDoc, keepPages);
            copied.forEach(pg => newPdf.addPage(pg));
          }
          // else empty PDF (0 pages)

          const newBytes = await newPdf.save();
          const editedBlob = new Blob([newBytes], { type: 'application/pdf' });
          // store blob and url for preview/download
          if (f.editedUrl) URL.revokeObjectURL(f.editedUrl);
          f.editedBlob = editedBlob;
          f.editedUrl = URL.createObjectURL(editedBlob);

          // Show preview block for this file
          const preview = document.createElement('div');
          preview.className = 'preview-block';
          preview.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
              <div><strong>${escapeHtml(f.file.name)}</strong> — <span class="muted small">${keepPages.length} pages kept, ${f.deletedPages.size} removed</span></div>
              <div style="display:flex;gap:8px">
                <a class="btn btn-ghost small" href="${f.editedUrl}" download="${safeFileName(f.file.name.replace(/\.pdf$/i,'') + '-edited.pdf')}"><i class="fa-solid fa-download"></i> Download</a>
                <button class="btn btn-ghost small" data-open-preview>Open Preview</button>
              </div>
            </div>
            <div style="margin-top:10px;display:none" data-preview-container>
              <iframe class="preview" src="${f.editedUrl}"></iframe>
            </div>
          `;
          preview.querySelector('[data-open-preview]').addEventListener('click', (e) => {
            const cont = preview.querySelector('[data-preview-container]');
            cont.style.display = cont.style.display === 'none' ? 'block' : 'none';
          });

          editedPreviews.appendChild(preview);

        } catch (err) {
          console.error('Error creating edited PDF for', f.file.name, err);
          const fail = document.createElement('div');
          fail.className = 'preview-block';
          fail.innerHTML = `<strong>${escapeHtml(f.file.name)}</strong> — <span class="muted">Failed to create edited PDF</span>`;
          editedPreviews.appendChild(fail);
        }
      }

      setGlobalStatus('Edited PDFs created. Use the Download buttons or "Download All Edited" to get files.');
      downloadAllBtn.disabled = false;
      loadBtn.disabled = false;
      clearBtn.disabled = false;
      deleteBtn.disabled = false;
    };

    // Download all edited PDFs individually (triggers multiple downloads)
    downloadAllBtn.onclick = () => {
      filesState.forEach(f => {
        if (f.editedBlob) {
          const a = document.createElement('a');
          a.href = f.editedUrl;
          a.download = safeFileName(f.file.name.replace(/\.pdf$/i, '') + '-edited.pdf');
          document.body.appendChild(a);
          a.click();
          a.remove();
        }
      });
    };

    // Utility: sanitize filename for download
    function safeFileName(name) {
      return name.replace(/[<>:"/\\|?*\x00-\x1F]/g, '_');
    }

    // Utility: escape html in strings for insertion into textContent contexts where needed
    function escapeHtml(s){
      if (!s) return '';
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    // When user navigates away, revoke created object URLs
    window.addEventListener('beforeunload', () => {
      filesState.forEach(f => {
        if (f.editedUrl) URL.revokeObjectURL(f.editedUrl);
      });
    });
  </script>
</body>
</html>
