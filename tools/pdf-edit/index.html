<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Edit PDF Online - Smarttool Hub (Real PDF.js + pdf-lib)</title>
  <meta name="description" content="Edit PDF files online - add text, shapes, and annotations. 100% client-side, using PDF.js and pdf-lib."/>
  <link rel="icon" href="https://img.icons8.com/fluency/48/toolbox.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    /* (kept your original theme & layout with slight adjustments) */
    :root{
      --bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;
      --primary:#22d3ee;--muted:#9fb3c8;--radius:12px;
    }
    body.light{
      --bg:#f6f8fb;--text:#0b1220;--card:#ffffff;--border:#e6eefc;
      --primary:#0b74ff;--muted:#556677;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg);color:var(--text);transition:background .25s,color .25s;
      min-height:100vh;display:flex;flex-direction:column;
    }
    .container{max-width:1400px;margin:0 auto;padding:20px;width:100%}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:var(--card);border-bottom:1px solid var(--border);padding:14px 20px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:46px;height:46px;border-radius:10px}
    .brand .title{font-size:1.25rem;font-weight:700;color:var(--primary);margin:0}
    .brand .tag{font-size:.9rem;color:var(--muted)}
    .header-actions{display:flex;gap:10px;align-items:center}
    .btn-header{
      border:1px solid var(--border);background:transparent;padding:8px 12px;border-radius:8px;
      color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;text-decoration:none;font-weight:600
    }
    .btn-header:hover{border-color:var(--primary);color:var(--primary)}
    .tool-content {
      background:var(--card);border-radius:var(--radius);border:1px solid var(--border);
      padding:25px;margin-top:20px;
    }
    .tool-title { font-size:1.8rem;margin-bottom:5px;color:var(--primary); }
    .tool-description { color:var(--muted);margin-bottom:25px; }
    .upload-area { border:2px dashed var(--border);border-radius:var(--radius);padding:40px;text-align:center;margin-bottom:25px;transition:all 0.3s;cursor:pointer;background:var(--bg); }
    .upload-area.dragover { border-color:var(--primary);background:rgba(34,211,238,0.05); }
    .upload-icon { font-size:3rem;color:var(--muted);margin-bottom:15px; }
    .upload-text { color:var(--text);margin-bottom:15px;font-weight:600; }
    .upload-subtext { color:var(--muted);font-size:0.9rem; }
    .file-input { display:none; }
    .selected-file { display:flex;align-items:center;gap:12px;padding:15px;background:var(--bg);border-radius:var(--radius);border:1px solid var(--border);margin-bottom:25px; }
    .file-icon { font-size:1.5rem;color:var(--primary); }
    .file-info { flex:1; }
    .file-name { font-weight:600;margin-bottom:4px;color:var(--text); }
    .file-size { color:var(--muted);font-size:0.9rem; }
    .remove-file { background:transparent;border:none;color:var(--muted);cursor:pointer;padding:5px;border-radius:4px; }
    .remove-file:hover { color:#ef4444; }
    .editor-container { display:grid;grid-template-columns:300px 1fr;gap:20px;margin-bottom:25px; }
    .toolbar { background:var(--bg);border-radius:var(--radius);border:1px solid var(--border);padding:15px; }
    .toolbar-section { margin-bottom:20px; }
    .toolbar-section h3 { margin:0 0 12px 0;color:var(--primary);font-size:1rem; }
    .tool-btn { display:flex;align-items:center;gap:10px;padding:10px;width:100%;text-align:left;background:transparent;border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;margin-bottom:8px;transition:all 0.2s; }
    .tool-btn:hover, .tool-btn.active { background:var(--primary);color:#00131f;border-color:var(--primary); }
    .tool-btn i { width:20px;text-align:center; }
    .color-picker { display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;margin-bottom:15px; }
    .color-option { width:30px;height:30px;border-radius:50%;cursor:pointer;border:2px solid var(--border);transition:transform 0.2s; }
    .color-option:hover, .color-option.active { transform:scale(1.12);border-color:var(--text); }
    .viewer { background:var(--bg);border-radius:var(--radius);border:1px solid var(--border);padding:20px;position:relative; }
    .pdf-page { position:relative;margin:0 auto 18px auto; box-shadow:0 6px 30px rgba(0,0,0,0.3); display:block; }
    .page-controls { display:flex;justify-content:center;align-items:center;gap:15px;margin-top:5px; }
    .page-btn { padding:8px 15px;border-radius:var(--radius);border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer; }
    .action-buttons { display:flex;gap:12px;flex-wrap:wrap;margin-top:8px; }
    .btn { padding:12px 20px;border-radius:var(--radius);border:none;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px; }
    .btn-primary { background:var(--primary);color:#00131f; }
    .btn-secondary { background:var(--card);color:var(--text);border:1px solid var(--border); }
    .status-message { margin-top:15px;padding:10px;border-radius:var(--radius);background:var(--bg);border:1px solid var(--border);color:var(--muted);font-size:0.9rem;display:none; }
    .status-success { border-color:#10b981;color:#10b981; }
    .status-error { border-color:#ef4444;color:#ef4444; }
    footer{margin-top:auto;padding:18px 0;background:var(--card);border-top:1px solid var(--border)}
    .footer-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .footer-links{display:flex;gap:14px;flex-wrap:wrap}
    .footer-links a{color:var(--primary);text-decoration:none;font-weight:600}
    @media (max-width:1024px){ .editor-container{grid-template-columns:1fr;} .toolbar{order:2;} .viewer{order:1;} }
    @media (max-width:720px){ header{flex-direction:column;align-items:flex-start;gap:10px} .header-actions{align-self:flex-end} .action-buttons{flex-direction:column;} .btn{width:100%;justify-content:center;} }
  </style>
</head>
<body>
<header class="container">
  <div class="brand">
    <a href="index.html" style="display:flex;align-items:center;gap:12px;text-decoration:none;">
      <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="Smarttool Hub Logo">
      <div>
        <div class="title">Smarttool Hub</div>
        <div class="tag">Fast • Private • 100% Client-side</div>
      </div>
    </a>
  </div>
  <div class="header-actions">
    <a href="index.html" class="btn-header"><i class="fa-solid fa-house"></i> Home</a>
    <button class="btn-header" id="themeToggle" title="Toggle dark/light mode"><i class="fa-solid fa-moon"></i></button>
  </div>
</header>

<main class="container">
  <div class="tool-content">
    <h1 class="tool-title">Edit PDF Online</h1>
    <p class="tool-description">Edit PDF files by adding text, shapes, and annotations. Your files are processed entirely in your browser—no server uploads.</p>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon"><i class="fas fa-file-pdf"></i></div>
      <div class="upload-text">Drop your PDF file here or click to browse</div>
      <div class="upload-subtext">Maximum file size: 200MB</div>
      <input type="file" id="fileInput" class="file-input" accept=".pdf">
    </div>

    <div id="selectedFileContainer" style="display:none;">
      <div class="selected-file">
        <div class="file-icon"><i class="fas fa-file-pdf"></i></div>
        <div class="file-info">
          <div class="file-name" id="fileName">document.pdf</div>
          <div class="file-size" id="fileSize">0 KB</div>
        </div>
        <button class="remove-file" id="removeFile"><i class="fas fa-times"></i></button>
      </div>
    </div>

    <div class="editor-container" id="editorContainer" style="display:none;">
      <div class="toolbar">
        <div class="toolbar-section">
          <h3>Edit Tools</h3>
          <button class="tool-btn active" data-tool="pan"><i class="fas fa-hand-pointer"></i> Pan/Select</button>
          <button class="tool-btn" data-tool="text"><i class="fas fa-font"></i> Add Text</button>
          <button class="tool-btn" data-tool="rectangle"><i class="fas fa-square"></i> Rectangle</button>
          <button class="tool-btn" data-tool="circle"><i class="fas fa-circle"></i> Circle</button>
          <button class="tool-btn" data-tool="highlight"><i class="fas fa-highlighter"></i> Highlight</button>
          <button class="tool-btn" data-tool="pen"><i class="fas fa-pen"></i> Freehand</button>
        </div>

        <div class="toolbar-section">
          <h3>Text Options</h3>
          <div style="display:flex;gap:8px;">
            <select id="fontSize" style="background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px;">
              <option value="12">12px</option>
              <option value="14">14px</option>
              <option value="16" selected>16px</option>
              <option value="18">18px</option>
              <option value="24">24px</option>
            </select>
            <input id="textInputPreview" type="text" placeholder="Preview text" style="flex:1;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px;" />
          </div>
        </div>

        <div class="toolbar-section">
          <h3>Colors</h3>
          <div class="color-picker" id="colorPicker">
            <div class="color-option active" style="background:#000000;" data-color="#000000"></div>
            <div class="color-option" style="background:#ff0000;" data-color="#ff0000"></div>
            <div class="color-option" style="background:#0000ff;" data-color="#0000ff"></div>
            <div class="color-option" style="background:#00cc00;" data-color="#00cc00"></div>
            <div class="color-option" style="background:#ffff00;" data-color="#ffff00"></div>
            <div class="color-option" style="background:#ff00ff;" data-color="#ff00ff"></div>
            <div class="color-option" style="background:#00ffff;" data-color="#00ffff"></div>
            <div class="color-option" style="background:#ff8800;" data-color="#ff8800"></div>
          </div>
        </div>

        <div class="toolbar-section">
          <h3>Actions</h3>
          <button class="tool-btn" id="undoBtn"><i class="fas fa-undo"></i> Undo</button>
          <button class="tool-btn" id="redoBtn"><i class="fas fa-redo"></i> Redo</button>
          <button class="tool-btn" id="clearBtn"><i class="fas fa-trash"></i> Clear Page</button>
        </div>
      </div>

      <div class="viewer" id="viewer">
        <!-- pdf pages will be appended here -->
        <div style="display:flex;justify-content:center;gap:12px;align-items:center;margin-bottom:10px;">
          <button class="page-btn" id="prevPage"><i class="fas fa-chevron-left"></i> Prev</button>
          <div class="page-info" id="pageInfo">Page 0 of 0</div>
          <button class="page-btn" id="nextPage">Next <i class="fas fa-chevron-right"></i></button>
        </div>
        <div id="pagesContainer"></div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-primary" id="saveBtn" disabled><i class="fas fa-save"></i> Save Changes</button>
      <button class="btn btn-secondary" id="downloadBtn" disabled><i class="fas fa-download"></i> Download Edited PDF</button>
      <button class="btn btn-secondary" id="resetBtn"><i class="fas fa-redo"></i> Reset</button>
    </div>

    <div id="statusMessage" class="status-message"></div>
  </div>
</main>

<footer class="container">
  <div class="footer-inner">
    <div>© <span id="year"></span> Smarttool Hub</div>
    <div class="footer-links">
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
      <a href="contact.html">Contact</a>
      <a href="comments.html">Comments</a>
      <a href="faq.html">FAQ</a>
    </div>
  </div>
</footer>

<!-- PDF.js (rendering) and pdf-lib (editing/saving) via CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
  // Set current year
  document.getElementById('year').textContent = new Date().getFullYear();

  // Theme toggle (keep)
  const themeToggle = document.getElementById('themeToggle');
  if (localStorage.getItem('sth_theme') === 'light') {
    document.body.classList.add('light');
    themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
  }
  themeToggle.onclick = () => {
    document.body.classList.toggle('light');
    if (document.body.classList.contains('light')) {
      themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
      localStorage.setItem('sth_theme', 'light');
    } else {
      themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
      localStorage.removeItem('sth_theme');
    }
  };

  // PDF.js worker setup
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

  // Elements
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const selectedFileContainer = document.getElementById('selectedFileContainer');
  const fileName = document.getElementById('fileName');
  const fileSize = document.getElementById('fileSize');
  const removeFile = document.getElementById('removeFile');
  const editorContainer = document.getElementById('editorContainer');
  const pagesContainer = document.getElementById('pagesContainer');
  const pageInfo = document.getElementById('pageInfo');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  const saveBtn = document.getElementById('saveBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const statusMessage = document.getElementById('statusMessage');
  const toolButtons = document.querySelectorAll('.tool-btn[data-tool]');
  const colorOptions = document.querySelectorAll('.color-option');
  const fontSizeSelect = document.getElementById('fontSize');
  const textPreview = document.getElementById('textInputPreview');
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  const clearBtn = document.getElementById('clearBtn');

  // State
  let pdfDoc = null; // pdf.js document
  let originalPdfBytes = null; // ArrayBuffer of original
  let totalPages = 0;
  let currentPageIndex = 0; // 0-based
  let currentTool = 'pan';
  let currentColor = '#000000';
  let scale = 1.2; // default render scale (mobile/desktop may adjust)
  let pageViews = []; // stores objects {page, viewport, canvas, overlay, historyStack, redoStack}
  const MAX_HISTORY = 50;

  // Wire up upload & drag/drop
  uploadArea.addEventListener('click', () => fileInput.click());
  uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
  uploadArea.addEventListener('drop', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); const f = e.dataTransfer.files[0]; if (f && f.type === 'application/pdf') handleFile(f); else showStatus('Please drop a PDF file', 'error'); });
  fileInput.addEventListener('change', e => { const f = e.target.files[0]; if (!f) return; if (f.type !== 'application/pdf') return showStatus('Please select a PDF file', 'error'); handleFile(f); });
  removeFile.addEventListener('click', resetTool);

  // Tools & color pickers
  document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentTool = btn.getAttribute('data-tool');
      showStatus(`Selected tool: ${currentTool}`, 'success');
    });
  });
  colorOptions.forEach(opt => { opt.addEventListener('click', () => { colorOptions.forEach(o => o.classList.remove('active')); opt.classList.add('active'); currentColor = opt.dataset.color; showStatus('Color: '+currentColor,'success'); }); });

  // Undo/Redo/Clear actions (operate on currently visible page)
  undoBtn.addEventListener('click', () => { const pv = pageViews[currentPageIndex]; if (!pv) return; if (pv.historyStack.length > 1) { pv.redoStack.push(pv.historyStack.pop()); const img = pv.historyStack[pv.historyStack.length-1]; restoreOverlayFromDataURL(pv.overlay, img); showStatus('Undo', 'success'); } });
  redoBtn.addEventListener('click', () => { const pv = pageViews[currentPageIndex]; if (!pv) return; if (pv.redoStack.length) { const img = pv.redoStack.pop(); pv.historyStack.push(img); restoreOverlayFromDataURL(pv.overlay, img); showStatus('Redo', 'success'); } });
  clearBtn.addEventListener('click', () => { const pv = pageViews[currentPageIndex]; if (!pv) return; pushHistorySnapshot(pv); clearCanvas(pv.overlay); showStatus('Cleared annotations on page', 'success'); });

  // Prev/Next page controls simply change the scroll to that page and update current index
  prevPageBtn.addEventListener('click', () => { if (currentPageIndex <= 0) return; setCurrentPage(currentPageIndex - 1); });
  nextPageBtn.addEventListener('click', () => { if (currentPageIndex >= totalPages - 1) return; setCurrentPage(currentPageIndex + 1); });

  saveBtn.addEventListener('click', async () => {
    showStatus('Preparing edited PDF for download...', 'info');
    try {
      await generateEditedPdfAndDownload();
    } catch (err) {
      console.error(err);
      showStatus('Error generating PDF: ' + err.message, 'error');
    }
  });
  downloadBtn.addEventListener('click', () => saveBtn.click());
  resetBtn.addEventListener('click', resetTool);

  // Handle file
  async function handleFile(file) {
    try {
      showStatus('Loading PDF...', 'info');
      selectedFileContainer.style.display = 'block';
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);

      // read arrayBuffer
      originalPdfBytes = await file.arrayBuffer();

      // load PDF with PDF.js
      pdfDoc = await pdfjsLib.getDocument({ data: originalPdfBytes }).promise;
      totalPages = pdfDoc.numPages;

      // cleanup any previous
      pagesContainer.innerHTML = '';
      pageViews = [];

      // render pages
      for (let i = 1; i <= totalPages; ++i) {
        await renderPage(i);
      }

      editorContainer.style.display = 'grid';
      saveBtn.disabled = false;
      downloadBtn.disabled = false;
      setCurrentPage(0);
      showStatus('PDF loaded. You can now edit pages.', 'success');

    } catch (err) {
      console.error(err);
      showStatus('Failed to load PDF: ' + err.message, 'error');
    }
  }

  // Render single page (1-based)
  async function renderPage(pageNumber) {
    const page = await pdfDoc.getPage(pageNumber);
    const viewport = page.getViewport({ scale });

    // container for page
    const wrapper = document.createElement('div');
    wrapper.className = 'pdf-page';
    wrapper.style.width = (viewport.width) + 'px';
    wrapper.style.height = (viewport.height + 30) + 'px';
    wrapper.style.position = 'relative';
    wrapper.style.marginBottom = '18px';

    // actual PDF canvas
    const canvas = document.createElement('canvas');
    canvas.width = Math.floor(viewport.width);
    canvas.height = Math.floor(viewport.height);
    canvas.style.display = 'block';
    canvas.style.width = viewport.width + 'px';
    canvas.style.height = viewport.height + 'px';
    canvas.style.background = '#fff';
    canvas.style.borderRadius = '6px';
    canvas.style.overflow = 'hidden';

    // overlay canvas for annotations (same size, positioned absolute)
    const overlay = document.createElement('canvas');
    overlay.width = canvas.width;
    overlay.height = canvas.height;
    overlay.style.position = 'absolute';
    overlay.style.left = '50%';
    overlay.style.transform = 'translateX(-50%)';
    overlay.style.top = '0';
    overlay.style.cursor = 'crosshair';
    overlay.style.width = viewport.width + 'px';
    overlay.style.height = viewport.height + 'px';
    overlay.style.borderRadius = '6px';
    overlay.style.background = 'transparent';

    // label footer (page number)
    const label = document.createElement('div');
    label.style.textAlign = 'center';
    label.style.color = getComputedStyle(document.body).getPropertyValue('--muted') || '#9fb3c8';
    label.style.marginTop = '6px';
    label.textContent = `Page ${pageNumber} of ${totalPages}`;

    // append
    wrapper.appendChild(canvas);
    wrapper.appendChild(overlay);
    wrapper.appendChild(label);
    pagesContainer.appendChild(wrapper);

    // render page to canvas
    const ctx = canvas.getContext('2d');
    ctx.save();
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,canvas.width, canvas.height);
    ctx.restore();

    const renderContext = {
      canvasContext: ctx,
      viewport
    };
    await page.render(renderContext).promise;

    // create page view record
    const pv = {
      pageNumber,
      page,
      viewport,
      canvas,
      overlay,
      historyStack: [],
      redoStack: []
    };

    // start with empty snapshot
    pv.historyStack.push(overlay.toDataURL());
    pv.redoStack = [];

    // attach overlay interactions
    attachOverlayEvents(pv);

    pageViews.push(pv);
  }

  // Make overlay interactive: draw shapes/text/freehand depending on currentTool
  function attachOverlayEvents(pv) {
    const o = pv.overlay;
    const ctx = o.getContext('2d');
    let drawing = false;
    let startX=0, startY=0, lastX=0, lastY=0;
    let tempCanvas = null; // for preview shapes
    // helper: get mouse/touch coords relative to canvas
    function getPos(e) {
      const rect = o.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const x = (clientX - rect.left) * (o.width / rect.width);
      const y = (clientY - rect.top) * (o.height / rect.height);
      return { x, y };
    }

    // setup temp canvas for shape preview
    function ensureTemp() {
      if (!tempCanvas) {
        tempCanvas = document.createElement('canvas');
        tempCanvas.width = o.width;
        tempCanvas.height = o.height;
        tempCanvas.style.position = 'absolute';
        tempCanvas.style.left = o.style.left;
        tempCanvas.style.top = o.style.top;
        tempCanvas.style.transform = o.style.transform;
        tempCanvas.style.pointerEvents = 'none';
        o.parentElement.appendChild(tempCanvas);
      }
    }
    function removeTemp() {
      if (tempCanvas) { tempCanvas.parentElement.removeChild(tempCanvas); tempCanvas = null; }
    }

    o.addEventListener('mousedown', start);
    o.addEventListener('touchstart', start, {passive:false});
    o.addEventListener('mousemove', move);
    o.addEventListener('touchmove', move, {passive:false});
    o.addEventListener('mouseup', up);
    o.addEventListener('mouseleave', up);
    o.addEventListener('touchend', up);

    function start(e) {
      if (currentTool === 'pan') return;
      e.preventDefault();
      drawing = true;
      const p = getPos(e);
      startX = p.x; startY = p.y;
      lastX = p.x; lastY = p.y;

      if (currentTool === 'freehand' || currentTool === 'pen') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = (currentTool === 'pen') ? 2 : 3;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
      }

      // clear redo when new action starts
      pv.redoStack = [];
    }

    function move(e) {
      if (!drawing) return;
      e.preventDefault();
      const p = getPos(e);
      const x = p.x, y = p.y;

      if (currentTool === 'pen' || currentTool === 'freehand') {
        ctx.lineTo(x,y);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = (currentTool === 'pen') ? 2 : 3;
        ctx.stroke();
      } else {
        // shape preview on temp canvas
        ensureTemp();
        const tctx = tempCanvas.getContext('2d');
        tctx.clearRect(0,0,tempCanvas.width,tempCanvas.height);
        tctx.strokeStyle = currentColor;
        tctx.fillStyle = (currentTool === 'highlight') ? hexToRgba(currentColor, 0.35) : 'transparent';
        tctx.lineWidth = 2;
        if (currentTool === 'rectangle') {
          const w = x - startX, h = y - startY;
          tctx.strokeRect(startX, startY, w, h);
        } else if (currentTool === 'circle') {
          const r = Math.hypot(x - startX, y - startY);
          tctx.beginPath(); tctx.arc(startX, startY, r, 0, Math.PI*2); tctx.stroke();
        } else if (currentTool === 'highlight') {
          const w = x - startX, h = Math.max(12, Math.abs(y - startY));
          tctx.fillRect(startX, startY - (h/2), w, h);
        }
      }
      lastX = x; lastY = y;
    }

    function up(e) {
      if (!drawing) return;
      drawing = false;
      const p = getPos(e.changedTouches ? e.changedTouches[0] : e);
      const x = p.x, y = p.y;

      if (currentTool === 'pen' || currentTool === 'freehand') {
        // already drawn paths on overlay
        pushHistorySnapshot(pv);
      } else if (currentTool === 'text') {
        const userText = textPreview.value || prompt('Enter text:');
        if (userText) {
          ctx.font = `${fontSizeSelect.value}px Arial`;
          ctx.fillStyle = currentColor;
          ctx.fillText(userText, x, y);
          pushHistorySnapshot(pv);
        }
      } else {
        // finalize shape from temp canvas onto overlay
        if (tempCanvas) {
          const tctx = tempCanvas.getContext('2d');
          ctx.drawImage(tempCanvas, 0, 0);
          removeTemp();
          pushHistorySnapshot(pv);
        } else {
          // small click shapes (e.g., click rectangle)
          if (currentTool === 'rectangle') {
            ctx.strokeStyle = currentColor; ctx.lineWidth = 2; ctx.strokeRect(x, y, 100, 60);
            pushHistorySnapshot(pv);
          } else if (currentTool === 'circle') {
            ctx.strokeStyle = currentColor; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(x,y,30,0,Math.PI*2); ctx.stroke();
            pushHistorySnapshot(pv);
          } else if (currentTool === 'highlight') {
            ctx.fillStyle = hexToRgba(currentColor, 0.35); ctx.fillRect(x, y, 150, 20);
            pushHistorySnapshot(pv);
          }
        }
      }
    }
  }

  // Save snapshot for undo history
  function pushHistorySnapshot(pv) {
    try {
      const data = pv.overlay.toDataURL();
      pv.historyStack.push(data);
      if (pv.historyStack.length > MAX_HISTORY) pv.historyStack.shift();
      pv.redoStack = [];
    } catch (err) {
      console.warn('History snapshot failed', err);
    }
  }
  function restoreOverlayFromDataURL(overlay, dataURL) {
    const ctx = overlay.getContext('2d');
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0,0,overlay.width, overlay.height);
      ctx.drawImage(img, 0,0, overlay.width, overlay.height);
    };
    img.src = dataURL;
  }
  function clearCanvas(c) { c.getContext('2d').clearRect(0,0,c.width,c.height); }

  // Set current page index (0-based) and scroll to it
  function setCurrentPage(index) {
    if (index < 0 || index >= pageViews.length) return;
    currentPageIndex = index;
    const pv = pageViews[index];
    pageInfo.textContent = `Page ${index+1} of ${pageViews.length}`;
    // scroll into view smoothly
    pv.canvas.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Generate edited PDF by compositing each page (base canvas + overlay) into an image and embedding using pdf-lib
  async function generateEditedPdfAndDownload() {
    if (!originalPdfBytes) throw new Error('No PDF loaded');

    showStatus('Compositing pages...', 'info');

    // load with pdf-lib so we can reuse original pages' sizes and metadata
    const existingPdf = await PDFLib.PDFDocument.load(originalPdfBytes);
    const newPdf = existingPdf; // modify in-place

    // For each pageView, create combined image
    for (let i = 0; i < pageViews.length; ++i) {
      const pv = pageViews[i];
      // composite: draw base canvas and overlay into a temp canvas
      const composite = document.createElement('canvas');
      composite.width = pv.canvas.width;
      composite.height = pv.canvas.height;
      const cctx = composite.getContext('2d');
      // draw PDF page raster
      cctx.drawImage(pv.canvas, 0, 0);
      // draw overlay
      cctx.drawImage(pv.overlay, 0, 0);

      // convert to PNG bytes
      const dataUrl = composite.toDataURL('image/png');
      const pngBytes = dataURLToUint8Array(dataUrl);

      // embed into pdf-lib page
      const pngImage = await newPdf.embedPng(pngBytes);
      const page = newPdf.getPage(i); // use the existing page object
      const { width: pageW, height: pageH } = page.getSize();

      // scale image to page size (image pixels correspond to render scale; handle scale ratio)
      // compute scale factors between composite pixels and page size (points)
      // We assume viewport.width (pixels) corresponds to pageW (points) proportionally
      page.drawImage(pngImage, {
        x: 0,
        y: 0,
        width: pageW,
        height: pageH,
      });
    }

    showStatus('Finalizing PDF...', 'info');
    const modifiedPdfBytes = await newPdf.save();
    const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);

    // trigger download
    const a = document.createElement('a');
    a.href = url;
    a.download = 'edited-' + (fileName.textContent || 'document.pdf');
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { a.remove(); URL.revokeObjectURL(url); }, 1000);

    showStatus('Edited PDF downloaded successfully', 'success');
  }

  // Utility: convert dataURL to Uint8Array
  function dataURLToUint8Array(dataURL) {
    const base64 = dataURL.split(',')[1];
    const binary = atob(base64);
    const len = binary.length;
    const arr = new Uint8Array(len);
    for (let i = 0; i < len; i++) arr[i] = binary.charCodeAt(i);
    return arr;
  }

  // Helpers
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes','KB','MB','GB','TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  function showStatus(message, type) {
    statusMessage.style.display = 'block';
    statusMessage.textContent = message;
    statusMessage.classList.remove('status-success','status-error');
    if (type === 'success') statusMessage.classList.add('status-success');
    if (type === 'error') statusMessage.classList.add('status-error');
    if (type !== 'info') setTimeout(()=> statusMessage.style.display='none', 4000);
  }
  function resetTool() {
    // reset UI and state
    originalPdfBytes = null; pdfDoc = null; totalPages = 0; currentPageIndex = 0; pageViews = [];
    pagesContainer.innerHTML = '';
    editorContainer.style.display = 'none';
    selectedFileContainer.style.display = 'none';
    fileInput.value = '';
    saveBtn.disabled = true; downloadBtn.disabled = true;
    showStatus('Tool reset', 'success');
  }
  function hexToRgba(hex, alpha=0.4) {
    hex = hex.replace('#','');
    if (hex.length === 3) hex = hex.split('').map(s=>s+s).join('');
    const r = parseInt(hex.substr(0,2),16);
    const g = parseInt(hex.substr(2,2),16);
    const b = parseInt(hex.substr(4,2),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }

  // small UX: keyboard shortcuts for tools (T=text, R=rect, C=circle, H=highlight, P=pan, D=pen)
  window.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    const map = { 't':'text','r':'rectangle','c':'circle','h':'highlight','p':'pan','d':'pen' };
    if (map[e.key]) {
      document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>b.classList.remove('active'));
      const btn = document.querySelector('.tool-btn[data-tool="'+map[e.key]+'"]');
      if (btn) { btn.classList.add('active'); currentTool = map[e.key]; showStatus('Selected '+map[e.key],'success'); }
    }
  });
</script>
</body>
</html>
