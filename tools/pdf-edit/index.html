<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Edit PDF Online - Smarttool Hub</title>
  <meta name="description" content="Edit PDF online: annotate, add text, add image stamps, rotate, delete pages. 100% client-side."/>
  <link rel="icon" href="https://img.icons8.com/fluency/48/toolbox.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    :root{
      --bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;
      --primary:#22d3ee;--muted:#9fb3c8;--radius:12px;
    }
    body.light{
      --bg:#f6f8fb;--text:#0b1220;--card:#ffffff;--border:#e6eefc;
      --primary:#0b74ff;--muted:#556677;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg);color:var(--text);transition:background .25s,color .25s;
      min-height:100vh;display:flex;flex-direction:column;
    }
    .container{max-width:1200px;margin:0 auto;padding:20px;width:100%}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:var(--card);border-bottom:1px solid var(--border);padding:14px 20px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:46px;height:46px;border-radius:10px}
    .brand .title{font-size:1.25rem;font-weight:700;color:var(--primary);margin:0}
    .brand .tag{font-size:.9rem;color:var(--muted)}
    .header-actions{display:flex;gap:10px;align-items:center}
    .btn-header{
      border:1px solid var(--border);background:transparent;padding:8px 12px;border-radius:8px;
      color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;text-decoration:none;font-weight:600
    }
    .btn-header:hover{border-color:var(--primary);color:var(--primary)}
    .tool-content {
      background:var(--card);border-radius:var(--radius);border:1px solid var(--border);
      padding:25px;margin-top:20px;
    }
    .tool-title {
      font-size:1.8rem;margin-bottom:5px;color:var(--primary);
    }
    .tool-description { color:var(--muted);margin-bottom:15px;}
    .top-row{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .left-panel{flex:1;min-width:300px}
    .right-panel{width:380px;min-width:260px}
    .upload-area {
      border:2px dashed var(--border);border-radius:var(--radius);padding:28px;
      text-align:center;margin-bottom:16px;transition:all 0.3s;cursor:pointer;background:var(--bg);
    }
    .upload-area.dragover{border-color:var(--primary);background:rgba(34,211,238,0.04)}
    .upload-icon{font-size:2.6rem;color:var(--muted);margin-bottom:12px}
    .upload-text{color:var(--text);margin-bottom:6px;font-weight:700}
    .upload-subtext{color:var(--muted);font-size:0.9rem}
    .file-input{display:none}
    .viewer {
      border-radius:var(--radius);border:1px solid var(--border);background:var(--bg);
      padding:14px;min-height:340px;display:flex;gap:12px;overflow:hidden;
    }
    .thumbnails {
      width:110px;overflow:auto;border-right:1px solid var(--border);padding-right:10px;
    }
    .thumb {
      border-radius:8px;border:1px solid var(--border);margin-bottom:10px;padding:6px;background:var(--card);
      cursor:pointer;display:flex;flex-direction:column;gap:6px;align-items:center;
    }
    .thumb.active{outline:2px solid var(--primary)}
    .thumb canvas{width:90px;height:auto;border-radius:4px;display:block}
    .page-area{flex:1;display:flex;flex-direction:column;align-items:center;overflow:auto;padding:6px}
    .page-wrapper{position:relative;display:inline-block;margin:10px;}
    /* base PDF canvas */
    .pdf-canvas{display:block;border-radius:6px;box-shadow:0 4px 18px rgba(2,6,23,0.5)}
    /* annotation overlay sits exactly over pdf canvas */
    .overlay {
      position:absolute;left:0;top:0;pointer-events:none;
    }
    /* stamps/text items (draggable) */
    .stamp, .txt-stamp {
      position:absolute;cursor:move;pointer-events:auto;padding:4px;border-radius:6px;
      background:rgba(255,255,255,0.9);color:#000;border:1px dashed rgba(0,0,0,0.15);
      display:flex;align-items:center;gap:6px;
    }
    .txt-stamp{padding:6px 8px;background:rgba(34,211,238,0.12);color:var(--text);border:1px dashed rgba(34,211,238,0.15)}
    .toolbar {display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .btn {padding:10px 14px;border-radius:10px;border:none;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--primary);color:#00131f}
    .btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
    .controls {background:var(--card);border-radius:12px;padding:12px;border:1px solid var(--border)}
    .control-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    input[type=range]{width:100%}
    .status-message{margin-top:12px;padding:10px;border-radius:var(--radius);background:var(--bg);border:1px solid var(--border);color:var(--muted);font-size:0.9rem;display:none}
    .small {font-size:0.9rem;color:var(--muted)}
    footer{margin-top:auto;padding:18px 0;background:var(--card);border-top:1px solid var(--border)}
    .footer-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .footer-links{display:flex;gap:14px;flex-wrap:wrap}
    .footer-links a{color:var(--primary);text-decoration:none;font-weight:600}
    @media (max-width:900px){ .right-panel{width:100%} .top-row{flex-direction:column} .thumbnails{width:90px} }
  </style>
</head>
<body>
<header class="container">
  <div class="brand">
    <a href="#" style="display:flex;align-items:center;gap:12px;text-decoration:none;">
      <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="Smarttool Hub Logo">
      <div>
        <div class="title">Smarttool Hub</div>
        <div class="tag">Fast • Private • 100% Client-side</div>
      </div>
    </a>
  </div>
  <div class="header-actions">
    <a href="#" class="btn-header"><i class="fa-solid fa-house"></i> Home</a>
    <button class="btn-header" id="themeToggle" title="Toggle dark/light mode"><i class="fa-solid fa-moon"></i></button>
  </div>
</header>

<main class="container">
  <div class="tool-content">
    <h1 class="tool-title">Edit PDF Online</h1>
    <p class="tool-description">Annotate, add text or image stamps, draw, rotate & delete pages — all in your browser.</p>

    <div class="top-row">
      <div class="left-panel">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon"><i class="fas fa-file-pdf"></i></div>
          <div class="upload-text">Drop your PDF here or click to browse</div>
          <div class="upload-subtext">Max file size: 70MB • All edits are local to your browser</div>
          <input type="file" id="fileInput" class="file-input" accept=".pdf">
        </div>

        <div class="viewer" id="viewer" style="display:none">
          <div class="thumbnails" id="thumbs"></div>

          <div class="page-area" id="pageArea">
            <!-- pages rendered here -->
            <div class="small" id="noFileMsg">No PDF loaded. Upload a file to begin editing.</div>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <div class="toolbar">
          <button class="btn btn-primary" id="drawBtn"><i class="fa-solid fa-pen"></i> Draw</button>
          <button class="btn btn-secondary" id="textBtn"><i class="fa-solid fa-font"></i> Add Text</button>
          <button class="btn btn-secondary" id="imageBtn"><i class="fa-regular fa-image"></i> Image Stamp</button>
          <button class="btn btn-secondary" id="rotateBtn"><i class="fa-solid fa-rotate-right"></i> Rotate Page</button>
          <button class="btn btn-secondary" id="deletePageBtn"><i class="fa-solid fa-trash"></i> Delete Page</button>
        </div>

        <div class="controls">
          <div class="control-row">
            <label class="small" style="width:90px">Pen width</label>
            <input type="range" id="penWidth" min="1" max="12" value="3">
          </div>
          <div class="control-row">
            <label class="small" style="width:90px">Pen opacity</label>
            <input type="range" id="penOpacity" min="10" max="100" value="90">
          </div>
          <div class="control-row">
            <label class="small" style="width:90px">Text size</label>
            <input type="range" id="textSize" min="10" max="72" value="18">
          </div>
          <div class="control-row">
            <label class="small" style="width:90px">Stamp width</label>
            <input type="range" id="stampWidth" min="40" max="400" value="160">
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="btn btn-primary" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> Export PDF</button>
            <button class="btn btn-secondary" id="resetBtn"><i class="fa-solid fa-rotate-left"></i> Reset</button>
            <label class="btn btn-secondary" style="cursor:pointer">
              <i class="fa-solid fa-upload"></i> Upload Image
              <input type="file" id="imageInput" accept="image/*" style="display:none">
            </label>
          </div>

          <div id="statusMessage" class="status-message" style="display:none"></div>
        </div>

        <div style="margin-top:12px" class="small">
          • Click a thumbnail to open page. • Drag text/image stamps to reposition. • Draw tool supports freehand. • Export flattens page into visual PDF.
        </div>
      </div>
    </div>

  </div>
</main>

<footer class="container">
  <div class="footer-inner">
    <div>© <span id="year"></span> Smarttool Hub</div>
    <div class="footer-links">
      <a href="#">Privacy</a>
      <a href="#">Terms</a>
      <a href="#">Contact</a>
      <a href="#">FAQ</a>
    </div>
  </div>
</footer>

<!-- External libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
  // UI initialisations
  document.getElementById('year').textContent = new Date().getFullYear();
  const themeToggle = document.getElementById('themeToggle');
  if (localStorage.getItem('sth_theme') === 'light') {
    document.body.classList.add('light');
    themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
  }
  themeToggle.onclick = () => {
    document.body.classList.toggle('light');
    if (document.body.classList.contains('light')) {
      themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
      localStorage.setItem('sth_theme', 'light');
    } else {
      themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
      localStorage.removeItem('sth_theme');
    }
  };

  // PDF.js worker setup
  if (pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
    // use CDN worker from same version
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  }

  // Elements
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const viewer = document.getElementById('viewer');
  const thumbs = document.getElementById('thumbs');
  const pageArea = document.getElementById('pageArea');
  const statusMessage = document.getElementById('statusMessage');
  const drawBtn = document.getElementById('drawBtn');
  const textBtn = document.getElementById('textBtn');
  const imageBtn = document.getElementById('imageBtn');
  const rotateBtn = document.getElementById('rotateBtn');
  const deletePageBtn = document.getElementById('deletePageBtn');
  const saveBtn = document.getElementById('saveBtn');
  const resetBtn = document.getElementById('resetBtn');
  const imageInput = document.getElementById('imageInput');

  const penWidth = document.getElementById('penWidth');
  const penOpacity = document.getElementById('penOpacity');
  const textSize = document.getElementById('textSize');
  const stampWidth = document.getElementById('stampWidth');

  // State
  let pdfDoc = null;
  let pages = []; // each page: {canvas, overlayCanvas, width, height, rotation, annotations:[]}
  let currentPageIndex = 0;
  let fileBytes = null;
  let drawing = false;
  let drawMode = false;
  let activeTool = null; // 'draw' | 'text' | 'image' | null

  function showStatus(msg, type='info') {
    statusMessage.style.display = 'block';
    statusMessage.textContent = msg;
    statusMessage.style.borderColor = type === 'error' ? '#ef4444' : 'transparent';
    if (type === 'success') statusMessage.style.background = 'rgba(16,185,129,0.06)';
    else statusMessage.style.background = '';
    setTimeout(()=>{ statusMessage.style.display = 'none'; }, 4000);
  }

  // Drag & drop
  uploadArea.addEventListener('click', () => fileInput.click());
  uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
  uploadArea.addEventListener('drop', async e => {
    e.preventDefault(); uploadArea.classList.remove('dragover');
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f && f.type === 'application/pdf') {
      fileInput.files = e.dataTransfer.files; // so change event triggers if needed
      await loadFile(f);
    } else {
      showStatus('Please drop a valid PDF file', 'error');
    }
  });

  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    if (f.type !== 'application/pdf') { showStatus('Please select a PDF file', 'error'); return; }
    await loadFile(f);
  });

  async function loadFile(file) {
    try {
      showStatus('Loading PDF...', 'info');
      const arrayBuffer = await file.arrayBuffer();
      fileBytes = arrayBuffer;
      pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      viewer.style.display = 'flex';
      thumbs.innerHTML = '';
      pageArea.innerHTML = '';
      pages = [];
      await renderAllPages();
      showStatus('PDF loaded', 'success');
    } catch (err) {
      console.error(err);
      showStatus('Failed to load PDF', 'error');
    }
  }

  async function renderAllPages() {
    const numPages = pdfDoc.numPages;
    for (let i=1;i<=numPages;i++) {
      const p = await pdfDoc.getPage(i);
      const viewport = p.getViewport({scale:1});
      // scale to fit width approx 800px
      const targetWidth = 800;
      const scale = Math.min(1.6, targetWidth / viewport.width);
      const vp = p.getViewport({scale});
      // create base canvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = Math.round(vp.width);
      canvas.height = Math.round(vp.height);
      canvas.className = 'pdf-canvas';
      // render
      await p.render({canvasContext: ctx, viewport: vp}).promise;
      // overlay canvas for drawings
      const overlay = document.createElement('canvas');
      overlay.width = canvas.width;
      overlay.height = canvas.height;
      overlay.className = 'overlay';
      overlay.style.left = '0px'; overlay.style.top = '0px';
      overlay.style.pointerEvents = 'none';
      // page wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'page-wrapper';
      wrapper.style.width = canvas.width + 'px';
      wrapper.style.height = canvas.height + 'px';
      wrapper.dataset.index = i-1;

      // insert stamp container
      const stampContainer = document.createElement('div');
      stampContainer.style.position = 'absolute';
      stampContainer.style.left = '0';
      stampContainer.style.top = '0';
      stampContainer.style.width = canvas.width + 'px';
      stampContainer.style.height = canvas.height + 'px';
      stampContainer.style.pointerEvents = 'auto';

      wrapper.appendChild(canvas);
      wrapper.appendChild(overlay);
      wrapper.appendChild(stampContainer);

      // append to page area
      pageArea.appendChild(wrapper);

      // thumbnail canvas (small)
      const thumbCanvas = document.createElement('canvas');
      const tctx = thumbCanvas.getContext('2d');
      const thumbW = 90;
      const thumbScale = thumbW / canvas.width;
      thumbCanvas.width = Math.round(canvas.width * thumbScale);
      thumbCanvas.height = Math.round(canvas.height * thumbScale);
      tctx.drawImage(canvas, 0, 0, thumbCanvas.width, thumbCanvas.height);

      const thumbEl = document.createElement('div');
      thumbEl.className = 'thumb';
      const pNum = document.createElement('div');
      pNum.className = 'small'; pNum.style.fontWeight='700'; pNum.textContent = 'Page ' + i;
      thumbEl.appendChild(thumbCanvas);
      thumbEl.appendChild(pNum);

      thumbEl.addEventListener('click', () => {
        selectPage(i-1);
      });

      thumbs.appendChild(thumbEl);

      pages.push({
        pageNumber: i,
        canvas,
        overlay,
        wrapper,
        stampContainer,
        rotation: 0,
        annotations: [] // freehand strokes etc could go here
      });
    }
    // select first page
    selectPage(0);
  }

  function selectPage(idx) {
    currentPageIndex = idx;
    // highlight thumbnail
    Array.from(thumbs.children).forEach((t, i) => t.classList.toggle('active', i===idx));
    // scroll selected page into view
    const page = pages[idx];
    if (!page) return;
    page.wrapper.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // Drawing tool implementation
  drawBtn.addEventListener('click', () => {
    toggleTool('draw');
  });
  textBtn.addEventListener('click', () => {
    toggleTool('text');
  });
  imageBtn.addEventListener('click', () => {
    toggleTool('image');
    // open image picker
    imageInput.click();
  });

  rotateBtn.addEventListener('click', () => {
    rotateCurrentPage();
  });

  deletePageBtn.addEventListener('click', () => {
    deleteCurrentPage();
  });

  resetBtn.addEventListener('click', () => {
    // reload original file if available
    if (fileBytes) {
      pdfjsLib.getDocument({data: fileBytes}).promise.then(async (doc) => {
        pdfDoc = doc;
        thumbs.innerHTML=''; pageArea.innerHTML=''; pages=[]; await renderAllPages(); showStatus('Reset to original PDF', 'success');
      });
    } else {
      thumbs.innerHTML=''; pageArea.innerHTML=''; pages=[]; viewer.style.display='none'; showStatus('Reset', 'success');
    }
  });

  function toggleTool(tool) {
    if (activeTool === tool) { activeTool = null; disableTools(); return; }
    activeTool = tool;
    disableTools(false);
    if (tool === 'draw') { enableDrawMode(); }
    if (tool === 'text') { enableTextMode(); }
    if (tool === 'image') { /* waits for upload */ }
  }

  function disableTools(clear=true) {
    drawMode = false;
    // update buttons style
    drawBtn.classList.toggle('btn-primary', activeTool === 'draw');
    textBtn.classList.toggle('btn-primary', activeTool === 'text');
    imageBtn.classList.toggle('btn-primary', activeTool === 'image');
    // pointer behavior
    pages.forEach(p => {
      const overlay = p.overlay;
      if (overlay) overlay.style.pointerEvents = activeTool === 'draw' ? 'auto' : 'none';
      p.stampContainer.style.pointerEvents = activeTool === 'text' || activeTool === 'image' ? 'auto' : 'none';
    });
  }

  function enableDrawMode() {
    drawMode = true;
    const p = pages[currentPageIndex];
    if (!p) return;
    const overlay = p.overlay;
    overlay.style.pointerEvents = 'auto';
    const ctx = overlay.getContext('2d');
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.strokeStyle = `rgba(34,211,238,${penOpacity.value/100})`;
    ctx.lineWidth = penWidth.value;
    let drawingNow = false;
    let last = {x:0,y:0};

    function relPos(e) {
      const rect = overlay.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (overlay.width / rect.width);
      const y = (e.clientY - rect.top) * (overlay.height / rect.height);
      return {x,y};
    }

    function start(e) {
      drawingNow = true;
      last = relPos(e);
    }
    function move(e) {
      if (!drawingNow) return;
      const ppos = relPos(e);
      ctx.beginPath();
      ctx.moveTo(last.x,last.y);
      ctx.lineTo(ppos.x,ppos.y);
      ctx.stroke();
      last = ppos;
    }
    function end() { drawingNow=false; }

    // attach listeners to this overlay only
    overlay.addEventListener('mousedown', start);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);

    // also touch support
    overlay.addEventListener('touchstart', (ev)=>{ ev.preventDefault(); start(ev.touches[0]); });
    window.addEventListener('touchmove', (ev)=>{ move(ev.touches[0]); }, {passive:false});
    window.addEventListener('touchend', end);

    // update pen settings live
    penWidth.oninput = ()=> { ctx.lineWidth = penWidth.value; };
    penOpacity.oninput = ()=> { ctx.strokeStyle = `rgba(34,211,238,${penOpacity.value/100})`; };

    // when switching tools, remove listeners by re-rendering overlay into annotation data
    // We'll keep drawing pixels in overlay canvas; they will be flattened when exporting.
  }

  // Text mode: clicking on page adds editable text stamp
  function enableTextMode() {
    const p = pages[currentPageIndex];
    if (!p) return;
    const container = p.stampContainer;
    container.style.pointerEvents = 'auto';
    // single-click to add a text stamp
    function handler(e) {
      e.preventDefault();
      const rect = container.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (container.offsetWidth / rect.width);
      const y = (e.clientY - rect.top) * (container.offsetHeight / rect.height);
      addTextStampToPage(currentPageIndex, x, y);
      // once placed, keep text mode active until user toggles off
    }
    container.addEventListener('dblclick', handler); // double click to add
    container.addEventListener('click', handler);
    // keep handler reference to remove later? For simplicity we do not remove; deactivating tool disables pointer events.
  }

  function addTextStampToPage(pageIdx, x, y) {
    const p = pages[pageIdx];
    const el = document.createElement('div');
    el.className = 'txt-stamp';
    el.contentEditable = true;
    el.innerText = 'Text';
    el.style.left = (x - 20) + 'px';
    el.style.top = (y - 12) + 'px';
    el.style.fontSize = textSize.value + 'px';
    el.style.minWidth = '40px';
    el.style.maxWidth = '60%';
    // make draggable & resizable (basic)
    makeDraggable(el, p.stampContainer);
    p.stampContainer.appendChild(el);
  }

  // Image stamp upload handler
  imageInput.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const imgURL = URL.createObjectURL(f);
    addImageStampToPage(currentPageIndex, imgURL);
    // reset input
    imageInput.value = '';
  });

  function addImageStampToPage(pageIdx, url) {
    const p = pages[pageIdx];
    const img = document.createElement('img');
    img.className = 'stamp';
    img.src = url;
    img.style.left = '30px';
    img.style.top = '30px';
    const w = Number(stampWidth.value);
    img.style.width = w + 'px';
    img.style.height = 'auto';
    img.style.maxWidth = '80%';
    img.style.pointerEvents = 'auto';
    makeDraggable(img, p.stampContainer, true);
    p.stampContainer.appendChild(img);
  }

  // Make an element draggable within container
  function makeDraggable(el, container, isImage=false) {
    el.style.position = 'absolute';
    el.onmousedown = function(e) {
      e.preventDefault();
      let startX = e.clientX, startY = e.clientY;
      const rect = el.getBoundingClientRect();
      const parentRect = container.getBoundingClientRect();
      const offsetX = startX - rect.left;
      const offsetY = startY - rect.top;
      function onMove(ev) {
        const nx = ev.clientX - parentRect.left - offsetX;
        const ny = ev.clientY - parentRect.top - offsetY;
        el.style.left = Math.max(0, Math.min(nx, container.offsetWidth - rect.width)) + 'px';
        el.style.top = Math.max(0, Math.min(ny, container.offsetHeight - rect.height)) + 'px';
      }
      function onUp() { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); }
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
    };

    // make resizable on dblclick (image)
    if (isImage) {
      el.ondblclick = function() {
        // simple resize prompt
        const newW = prompt('Enter width in px (max 800):', el.width || el.style.width.replace('px','') || 160);
        if (newW) el.style.width = Math.min(1200, Number(newW)) + 'px';
      };
    } else {
      // editable text uses contentEditable; double-click to change size
      el.ondblclick = function() {
        const newSize = prompt('Text size (px):', parseInt(window.getComputedStyle(el).fontSize) || 18);
        if (newSize) el.style.fontSize = newSize + 'px';
      };
    }

    // allow delete by context menu
    el.oncontextmenu = function(ev) {
      ev.preventDefault();
      if (confirm('Delete this item?')) el.remove();
    };
  }

  // Rotate current page 90deg clockwise (visual only)
  function rotateCurrentPage() {
    const p = pages[currentPageIndex];
    if (!p) return;
    p.rotation = (p.rotation + 90) % 360;
    // apply CSS transform rotate to wrapper content
    p.wrapper.style.transform = 'rotate(' + p.rotation + 'deg)';
    // adjust wrapper size so rotated content doesn't overflow oddly (quick approach)
    if (p.rotation === 90 || p.rotation === 270) {
      p.wrapper.style.width = p.canvas.height + 'px';
      p.wrapper.style.height = p.canvas.width + 'px';
    } else {
      p.wrapper.style.width = p.canvas.width + 'px';
      p.wrapper.style.height = p.canvas.height + 'px';
    }
    showStatus('Page rotated', 'success');
  }

  function deleteCurrentPage() {
    if (!confirm('Delete current page? This action cannot be undone until you reset.')) return;
    const idx = currentPageIndex;
    // remove DOM and pages entry
    const removed = pages.splice(idx,1)[0];
    if (removed) {
      removed.wrapper.remove();
      // remove thumbnail
      if (thumbs.children[idx]) thumbs.children[idx].remove();
      // fix dataset indexes
      pages.forEach((p,i)=> { p.wrapper.dataset.index = i; if (thumbs.children[i]) thumbs.children[i].querySelector('.small').textContent = 'Page ' + (i+1); });
      // select nearest page
      selectPage(Math.max(0, idx-1));
      showStatus('Page deleted', 'success');
    }
  }

  // Export: flatten each page into image and embed into new PDF
  saveBtn.addEventListener('click', async () => {
    if (!pages.length) { showStatus('No pages to export', 'error'); return; }
    showStatus('Preparing PDF for export...', 'info');
    try {
      const newPdf = await PDFLib.PDFDocument.create();
      for (let i=0;i<pages.length;i++) {
        const p = pages[i];
        // create an offscreen canvas sized to page logical size
        const off = document.createElement('canvas');
        // if page is rotated, swap
        const rot = p.rotation || 0;
        if (rot === 90 || rot === 270) {
          off.width = p.canvas.height; off.height = p.canvas.width;
        } else { off.width = p.canvas.width; off.height = p.canvas.height; }
        const ctx = off.getContext('2d');
        // handle rotation draw: translate/rotate then draw
        if (rot !== 0) {
          ctx.translate(off.width/2, off.height/2);
          ctx.rotate(rot * Math.PI / 180);
          // draw base canvas centered
          ctx.drawImage(p.canvas, -p.canvas.width/2, -p.canvas.height/2, p.canvas.width, p.canvas.height);
          // overlays: draw drawing overlay and stamps similarly
          if (p.overlay) ctx.drawImage(p.overlay, -p.canvas.width/2, -p.canvas.height/2, p.canvas.width, p.canvas.height);
          // draw stamp container by rendering each child to canvas (images or text)
          await drawStampContainerToContext(p, ctx, -p.canvas.width/2, -p.canvas.height/2);
          // reset transform
          ctx.setTransform(1,0,0,1,0,0);
        } else {
          ctx.drawImage(p.canvas, 0, 0, p.canvas.width, p.canvas.height);
          if (p.overlay) ctx.drawImage(p.overlay, 0, 0, p.canvas.width, p.canvas.height);
          await drawStampContainerToContext(p, ctx, 0, 0);
        }

        // compress image to JPEG (quality 0.9)
        const imgData = off.toDataURL('image/jpeg', 0.9);
        const imgBytes = await (await fetch(imgData)).arrayBuffer();
        const img = await newPdf.embedJpg(imgBytes);
        const page = newPdf.addPage([img.width, img.height]);
        page.drawImage(img, {x:0,y:0,width:img.width,height:img.height});
      }
      const pdfBytes = await newPdf.save();
      const blob = new Blob([pdfBytes], {type:'application/pdf'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'edited.pdf'; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
      showStatus('PDF exported successfully', 'success');
    } catch (err) {
      console.error(err);
      showStatus('Failed to export PDF', 'error');
    }
  });

  // Helper to draw stamp container elements into the page context
  async function drawStampContainerToContext(pageObj, ctx, offsetX=0, offsetY=0) {
    const container = pageObj.stampContainer;
    // iterate children and draw accordingly
    for (let child of Array.from(container.children)) {
      if (child.tagName === 'IMG') {
        // images: draw at position and size
        const img = child;
        // compute numeric left/top in px (already absolute inside container)
        const left = parseFloat(img.style.left || 0) + offsetX;
        const top = parseFloat(img.style.top || 0) + offsetY;
        // natural width/height vs styled width
        const drawW = img.width || img.naturalWidth || parseFloat(img.style.width) || 100;
        const drawH = (img.naturalHeight * (drawW / img.naturalWidth)) || img.height || 80;
        // draw
        // ensure image is loaded
        if (!img.complete) await new Promise(res => { img.onload = res; img.onerror = res; });
        ctx.drawImage(img, left, top, drawW, drawH);
      } else {
        // text stamps or other elements: render using simple fillRect & draw text
        const rect = child.getBoundingClientRect();
        const parentRect = container.getBoundingClientRect();
        const left = parseFloat(child.style.left || 0) + offsetX;
        const top = parseFloat(child.style.top || 0) + offsetY;
        // read computed styles for font
        const fs = window.getComputedStyle(child);
        let fontSize = parseFloat(fs.fontSize) || 18;
        ctx.font = (fs.fontWeight || '600') + ' ' + fontSize + 'px Inter, Arial, sans-serif';
        // background
        ctx.fillStyle = fs.backgroundColor || 'rgba(255,255,255,0.9)';
        const w = child.offsetWidth, h = child.offsetHeight;
        ctx.fillRect(left, top, w, h);
        // text
        ctx.fillStyle = fs.color || '#000';
        // multiple lines
        const txt = child.innerText || child.textContent || '';
        const lines = txt.split('\n');
        let lineY = top + fontSize;
        for (let ln of lines) {
          ctx.fillText(ln, left + 6, lineY);
          lineY += fontSize * 1.1;
        }
      }
    }
  }

  // Simple utility: convert canvas to blob (promise)
  function canvasToBlob(canvas, type='image/jpeg', quality=0.9) {
    return new Promise(resolve => canvas.toBlob(resolve, type, quality));
  }

  // Page selection via thumbnail click already implemented: selectPage
  // keep active page in view: add click to page wrapper to set current
  pageArea.addEventListener('click', (e) => {
    const wrapper = e.target.closest('.page-wrapper');
    if (!wrapper) return;
    selectPage(parseInt(wrapper.dataset.index || 0, 10));
  });

  // Basic keyboard: Delete key to remove selected stamp if any selected (not implemented advanced)
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Delete') {
      // if any element is focused and it's a stamp, remove
      const el = document.activeElement;
      if (el && (el.classList.contains('stamp') || el.classList.contains('txt-stamp'))) {
        if (confirm('Delete selected item?')) el.remove();
      }
    }
  });

  // Utility: format bytes to readable
  function formatBytes(bytes) {
    if (!bytes) return '0 Bytes';
    const k = 1024, sizes = ['Bytes','KB','MB','GB'];
    const i = Math.floor(Math.log(bytes)/Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Simple UI helpers
  imageBtn.addEventListener('click', () => { /* opens file input via imageInput click initiated earlier */ });
  // When user clicks the "Image Stamp" top button and not using the hidden file input:
  imageBtn.addEventListener('dblclick', ()=> imageInput.click());

  // initial disable
  disableTools(true);

  // Basic fallback/error handling for library presence
  if (!pdfjsLib || !PDFLib) {
    alert('Required libraries not loaded. This tool needs PDF.js and pdf-lib from CDN.');
  }
</script>
</body>
</html>
