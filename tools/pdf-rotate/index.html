<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rotate PDF Pages - Smarttool Hub (PDF.js + pdf-lib)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root{--bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;--primary:#22d3ee;--muted:#9fb3c8;--radius:12px}
    body.light{--bg:#f6f8fb;--text:#0b1220;--card:#ffffff;--border:#e6eefc;--primary:#0b74ff;--muted:#556677}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    .container{max-width:1100px;margin:0 auto;padding:20px;width:100%}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border-bottom:1px solid var(--border);padding:14px 20px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:46px;height:46px;border-radius:8px}
    .title{font-weight:700;color:var(--primary)}
    .upload-area{border:2px dashed var(--border);border-radius:var(--radius);padding:28px;text-align:center;margin:18px 0;cursor:pointer}
    .upload-area.dragover{border-color:var(--primary);background:rgba(34,211,238,0.04)}
    .hidden{display:none}
    .tool-content{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);padding:22px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:8px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--primary);color:#00131f}
    .btn-muted{background:transparent;border:1px solid var(--border);color:var(--text)}
    .panel{display:flex;gap:20px}
    .left{flex:0 0 420px}
    .right{flex:1}
    canvas{max-width:100%;border-radius:8px;background:white}
    .page-list{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .thumb{width:100px;height:140px;border:1px solid var(--border);border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--bg)}
    .thumb canvas{width:100%;height:100%;object-fit:cover}
    .rotation-btn{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
    .rotation-btn.active{background:var(--primary);color:#00131f}
    .footer{margin-top:auto;padding:18px 0;background:var(--card);border-top:1px solid var(--border)}
    @media(max-width:880px){.panel{flex-direction:column}.left{flex:1}}
  </style>
</head>
<body>
  <header class="container">
    <div class="brand">
      <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="logo">
      <div>
        <div class="title">Smarttool Hub — Rotate PDF Pages</div>
        <div style="color:var(--muted);font-size:0.9rem">Client-side, private, no upload</div>
      </div>
    </div>
    <div>
      <button id="themeToggle" class="btn btn-muted" title="Toggle theme"><i class="fa-solid fa-moon"></i></button>
    </div>
  </header>

  <main class="container">
    <div class="tool-content">
      <div class="upload-area" id="uploadArea">
        <div style="font-size:28px;color:var(--muted)"><i class="fa-solid fa-file-pdf"></i></div>
        <div style="font-weight:700;margin-top:8px">Drop a PDF here or click to browse</div>
        <div style="color:var(--muted);margin-top:6px">Max size: 100MB — processed in your browser</div>
        <input id="fileInput" class="hidden" type="file" accept="application/pdf">
      </div>

      <div id="toolArea" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div style="font-weight:700" id="fileTitle">document.pdf</div>
          <div style="color:var(--muted)" id="fileInfo"></div>
        </div>

        <div class="panel" style="margin-top:14px">
          <div class="left">
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--bg)">
              <canvas id="pageCanvas" width="600" height="800"></canvas>
              <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
                <div style="display:flex;gap:8px;align-items:center">
                  <button id="prevPage" class="btn btn-muted"><i class="fa-solid fa-chevron-left"></i></button>
                  <button id="nextPage" class="btn btn-muted"><i class="fa-solid fa-chevron-right"></i></button>
                  <div id="pageLabel" style="color:var(--muted);font-weight:600"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                  <button class="rotation-btn" data-deg="90">Rotate +90°</button>
                  <button class="rotation-btn" data-deg="-90">Rotate -90°</button>
                  <button class="rotation-btn" data-deg="180">Rotate 180°</button>
                </div>
              </div>

              <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
                <label style="color:var(--muted);font-weight:600">Apply to:</label>
                <select id="applyScope">
                  <option value="current">Current page</option>
                  <option value="all">All pages</option>
                  <option value="range">Range</option>
                </select>
                <div id="rangeInputs" style="display:none;gap:6px;align-items:center">
                  <input id="rangeFrom" type="number" min="1" placeholder="from" style="width:72px;padding:6px;border-radius:8px;background:var(--bg);border:1px solid var(--border);color:var(--text)">
                  <input id="rangeTo" type="number" min="1" placeholder="to" style="width:72px;padding:6px;border-radius:8px;background:var(--bg);border:1px solid var(--border);color:var(--text)">
                </div>
              </div>

            </div>

            <div style="margin-top:12px">
              <div style="font-weight:700;margin-bottom:8px">Pages</div>
              <div class="page-list" id="pageList"></div>
            </div>
          </div>

          <div class="right">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Rotations</div>
              <div style="color:var(--muted)" id="rotationSummary">No rotations</div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="applyBtn" class="btn btn-primary"><i class="fa-solid fa-check-circle"></i> Apply</button>
              <button id="downloadBtn" class="btn btn-muted" disabled><i class="fa-solid fa-download"></i> Download PDF</button>
              <button id="resetBtn" class="btn btn-muted">Reset</button>
            </div>

            <div style="margin-top:16px;color:var(--muted)">
              <p>This tool uses <strong>PDF.js</strong> to render previews and <strong>pdf-lib</strong> to modify and save the rotated PDF — everything runs in your browser.</p>
              <p style="margin-top:8px">Notes: rotations are saved as cumulative degrees per page. Only client-side operations — no server involved.</p>
            </div>
          </div>
        </div>

      </div>

      <div id="status" style="margin-top:12px;color:var(--muted)"></div>
    </div>
  </main>

  <footer class="container footer">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>© <span id="year"></span> Smarttool Hub</div>
      <div style="color:var(--muted)">Privacy • Terms • Contact</div>
    </div>
  </footer>

  <!-- Libraries -->
  <!-- pdf-lib (unpkg) -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <!-- PDF.js (mozilla hosted build) -->
  <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    if (localStorage.getItem('sth_theme') === 'light') { document.body.classList.add('light'); themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>'; }
    themeToggle.onclick = () => { document.body.classList.toggle('light'); if (document.body.classList.contains('light')) { themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>'; localStorage.setItem('sth_theme','light'); } else { themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>'; localStorage.removeItem('sth_theme'); } };

    // PDF.js worker setup (mozilla hosted build sets pdfjsLib global)
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.js';
    }

    // Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const toolArea = document.getElementById('toolArea');
    const fileInfo = document.getElementById('fileInfo');
    const fileTitle = document.getElementById('fileTitle');
    const pageCanvas = document.getElementById('pageCanvas');
    const ctx = pageCanvas.getContext('2d');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageLabel = document.getElementById('pageLabel');
    const pageList = document.getElementById('pageList');
    const applyScope = document.getElementById('applyScope');
    const rangeInputs = document.getElementById('rangeInputs');
    const rangeFrom = document.getElementById('rangeFrom');
    const rangeTo = document.getElementById('rangeTo');
    const rotationBtns = document.querySelectorAll('.rotation-btn');
    const applyBtn = document.getElementById('applyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const status = document.getElementById('status');
    const rotationSummary = document.getElementById('rotationSummary');

    let arrayBuffer = null;
    let pdfDocJS = null; // pdf.js document
    let pdfDocLib = null; // pdf-lib loaded doc
    let totalPages = 0;
    let currentPage = 1;
    let pageRotations = {}; // pageIndex (1-based) -> degrees

    // UI helpers
    function setStatus(msg, isError) { status.textContent = msg; status.style.color = isError ? '#ef4444' : 'var(--muted)'; }

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); const f = e.dataTransfer.files[0]; if (f) handleFile(f); });
    fileInput.addEventListener('change', (e) => { const f = e.target.files[0]; if (f) handleFile(f); });

    function resetState() {
      arrayBuffer = null; pdfDocJS = null; pdfDocLib = null; totalPages = 0; currentPage = 1; pageRotations = {}; pageList.innerHTML = '';
      toolArea.classList.add('hidden'); downloadBtn.disabled = true; setStatus('');
      ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
      fileTitle.textContent = 'document.pdf';
      fileInfo.textContent = '';
    }

    resetBtn.addEventListener('click', () => { fileInput.value = ''; resetState(); });

    async function handleFile(file) {
      if (file.type !== 'application/pdf') { setStatus('Please select a PDF file', true); return; }
      if (file.size > 100 * 1024 * 1024) { setStatus('File too large (max 100MB)', true); return; }

      toolArea.classList.remove('hidden');
      fileTitle.textContent = file.name;
      fileInfo.textContent = `${(file.size/1024/1024).toFixed(2)} MB`;
      setStatus('Loading PDF...');

      arrayBuffer = await file.arrayBuffer();

      // Load with PDF.js to render previews
      try {
        pdfDocJS = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        totalPages = pdfDocJS.numPages;
        // initialize rotations
        for (let i=1;i<=totalPages;i++) pageRotations[i] = 0;
        buildThumbnails();
        renderPage(1);
        downloadBtn.disabled = false;
        setStatus('PDF loaded — preview ready');
      } catch (err) {
        console.error(err); setStatus('Error loading PDF (preview failed)', true); return;
      }

      // Load pdf-lib doc lazily when user clicks download
      pdfLibLoad();
    }

    // Build thumbnails (small canvases)
    async function buildThumbnails() {
      pageList.innerHTML = '';
      for (let p=1;p<=totalPages;p++) {
        const thumb = document.createElement('div'); thumb.className = 'thumb';
        const tc = document.createElement('canvas'); tc.width = 150; tc.height = 200; thumb.appendChild(tc);
        pageList.appendChild(thumb);

        // Render low-res thumbnail
        (async (pageNum, canvasEl) => {
          const page = await pdfDocJS.getPage(pageNum);
          const viewport = page.getViewport({scale: 0.2});
          const renderContext = {canvasContext: canvasEl.getContext('2d'), viewport};
          await page.render(renderContext).promise;
        })(p, tc);

        thumb.addEventListener('click', () => { changePage(p); });
      }
    }

    async function renderPage(pageNum) {
      if (!pdfDocJS) return;
      currentPage = pageNum;
      const page = await pdfDocJS.getPage(pageNum);
      const viewport = page.getViewport({scale: 1.5});

      // Resize canvas to match page aspect
      pageCanvas.width = viewport.width;
      pageCanvas.height = viewport.height;

      // Use an offscreen canvas to apply rotation while rendering
      const renderContext = {canvasContext: ctx, viewport};
      await page.render(renderContext).promise;

      // Apply CSS transform for preview rotation (client-side only)
      const degrees = pageRotations[pageNum] || 0;
      // We'll visually rotate the canvas by drawing into a temporary canvas and rotating
      if (degrees !== 0) {
        // create temp canvas
        const temp = document.createElement('canvas'); temp.width = pageCanvas.width; temp.height = pageCanvas.height;
        const tctx = temp.getContext('2d');
        tctx.translate(temp.width/2, temp.height/2);
        tctx.rotate((degrees * Math.PI) / 180);
        tctx.drawImage(pageCanvas, -temp.width/2, -temp.height/2);
        // replace content
        ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
        // If rotation swapped dims, adjust canvas size and draw appropriately
        if (degrees % 180 !== 0) {
          // swap
          const w = temp.height; const h = temp.width;
          pageCanvas.width = w; pageCanvas.height = h;
        }
        ctx.drawImage(temp, 0, 0);
      }

      pageLabel.textContent = `Page ${currentPage} of ${totalPages}`;
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages;
      updateRotationSummary();
    }

    prevPageBtn.addEventListener('click', () => { if (currentPage>1) renderPage(currentPage-1); });
    nextPageBtn.addEventListener('click', () => { if (currentPage<totalPages) renderPage(currentPage+1); });

    applyScope.addEventListener('change', () => { rangeInputs.style.display = applyScope.value === 'range' ? 'flex' : 'none'; });

    // Rotation buttons change selected rotation (visual active state)
    let selectedRotation = 0;
    rotationBtns.forEach(b => {
      b.addEventListener('click', () => {
        rotationBtns.forEach(bb => bb.classList.remove('active'));
        b.classList.add('active');
        selectedRotation = parseInt(b.getAttribute('data-deg')) || 0;
      });
    });

    // Apply rotation (updates pageRotations and preview)
    applyBtn.addEventListener('click', async () => {
      if (!selectedRotation) { setStatus('Select a rotation first', true); return; }
      let pages = [];
      if (applyScope.value === 'current') pages = [currentPage];
      else if (applyScope.value === 'all') pages = Array.from({length: totalPages}, (_,i)=>i+1);
      else if (applyScope.value === 'range') {
        const from = parseInt(rangeFrom.value) || 1; const to = parseInt(rangeTo.value) || totalPages;
        if (from>to || from<1 || to>totalPages) { setStatus('Invalid range', true); return; }
        pages = Array.from({length: to-from+1}, (_,i) => from + i);
      }

      pages.forEach(p => { pageRotations[p] = (pageRotations[p] + selectedRotation) % 360; });
      setStatus(`Rotation applied to ${pages.length} page(s)`);
      // clear selection
      rotationBtns.forEach(bb => bb.classList.remove('active')); selectedRotation = 0;
      // re-render current page to reflect rotation preview
      await renderPage(currentPage);
      updateRotationSummary();
    });

    function updateRotationSummary() {
      const changed = Object.entries(pageRotations).filter(([k,v]) => v !== 0).map(([k,v]) => `${k}:${v}°`);
      rotationSummary.textContent = changed.length ? changed.join(', ') : 'No rotations';
    }

    // Load pdf-lib document (lazy)
    async function pdfLibLoad() {
      try {
        pdfDocLib = await PDFLib.PDFDocument.load(arrayBuffer);
      } catch (err) {
        console.warn('pdf-lib load failed initially:', err);
      }
    }

    // Download rotated PDF using pdf-lib
    downloadBtn.addEventListener('click', async () => {
      if (!arrayBuffer) return;
      setStatus('Preparing rotated PDF...');

      try {
        // load fresh each time to avoid state issues
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        const pageCount = pdfDoc.getPageCount();

        for (let i=0;i<pageCount;i++) {
          const pIndex = i+1;
          const deg = pageRotations[pIndex] || 0;
          if (deg !== 0) {
            // pdf-lib provides degrees() helper
            const page = pdfDoc.getPage(i);
            // setRotation expects a Rotation object -> use degrees helper
            page.setRotation(PDFLib.degrees(deg + (page.getRotation?.()?.angle || 0)));
          }
        }

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], {type: 'application/pdf'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'rotated-' + (fileTitle.textContent || 'document.pdf'); document.body.appendChild(a); a.click();
        setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
        setStatus('Rotated PDF ready');
      } catch (err) {
        console.error(err); setStatus('Error creating rotated PDF', true);
      }
    });

    // Change page helper
    function changePage(n) { if (n<1 || n>totalPages) return; renderPage(n); }

  </script>
</body>
</html>
