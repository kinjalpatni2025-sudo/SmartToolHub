<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Unlock PDF - Smarttool Hub</title>
  <meta name="description" content="Remove password protection from your PDF files. 100% browser-based, private and fast."/>
  <link rel="icon" href="https://img.icons8.com/fluency/48/toolbox.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    :root{
      --bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;
      --primary:#22d3ee;--muted:#9fb3c8;--radius:12px;
    }
    body.light{
      --bg:#f6f8fb;--text:#0b1220;--card:#ffffff;--border:#e6eefc;
      --primary:#0b74ff;--muted:#556677;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg);color:var(--text);transition:background .25s,color .25s;
      min-height:100vh;display:flex;flex-direction:column;
    }
    .container{max-width:1200px;margin:0 auto;padding:20px;width:100%}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:var(--card);border-bottom:1px solid var(--border);padding:14px 20px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:46px;height:46px;border-radius:10px}
    .brand .title{font-size:1.25rem;font-weight:700;color:var(--primary);margin:0}
    .brand .tag{font-size:.9rem;color:var(--muted)}
    .header-actions{display:flex;gap:10px;align-items:center}
    .btn-header{
      border:1px solid var(--border);background:transparent;padding:8px 12px;border-radius:8px;
      color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;text-decoration:none;font-weight:600
    }
    .btn-header:hover{border-color:var(--primary);color:var(--primary)}
    .tool-content {
      background:var(--card);border-radius:var(--radius);border:1px solid var(--border);
      padding:25px;margin-top:20px;
    }
    .tool-title {
      font-size:1.8rem;margin-bottom:5px;color:var(--primary);
    }
    .tool-description {
      color:var(--muted);margin-bottom:25px;
    }
    .upload-area {
      border:2px dashed var(--border);border-radius:var(--radius);padding:40px;
      text-align:center;margin-bottom:25px;transition:all 0.3s;cursor:pointer;
      background:var(--bg);
    }
    .upload-area:hover, .upload-area.dragover {
      border-color:var(--primary);background:rgba(34,211,238,0.05);
    }
    .upload-icon {
      font-size:3rem;color:var(--muted);margin-bottom:15px;
    }
    .upload-text {
      color:var(--text);margin-bottom:15px;font-weight:600;
    }
    .upload-subtext {
      color:var(--muted);font-size:0.9rem;
    }
    .file-input {
      display:none;
    }
    .selected-file {
      display:flex;align-items:center;gap:12px;padding:15px;
      background:var(--bg);border-radius:var(--radius);border:1px solid var(--border);
      margin-bottom:25px;
    }
    .file-icon {
      font-size:1.5rem;color:var(--primary);
    }
    .file-info {
      flex:1;
    }
    .file-name {
      font-weight:600;margin-bottom:4px;color:var(--text);
    }
    .file-size {
      color:var(--muted);font-size:0.9rem;
    }
    .remove-file {
      background:transparent;border:none;color:var(--muted);cursor:pointer;
      padding:5px;border-radius:4px;
    }
    .remove-file:hover {
      color:#ef4444;
    }
    .password-section {
      margin-bottom:25px;
    }
    .password-section h3 {
      margin-bottom:15px;color:var(--primary);font-size:1.1rem;
    }
    .option-group {
      margin-bottom:15px;
    }
    .option-group label {
      display:block;margin-bottom:8px;font-weight:500;color:var(--text);
    }
    .option-group input {
      width:100%;padding:10px 12px;border-radius:var(--radius);
      background:var(--bg);border:1px solid var(--border);color:var(--text);
    }
    .password-note {
      background:var(--bg);border-radius:var(--radius);border:1px solid var(--border);
      padding:15px;margin-top:20px;
    }
    .password-note h4 {
      margin:0 0 10px 0;color:var(--primary);font-size:1rem;
      display:flex;align-items:center;gap:8px;
    }
    .password-note p {
      margin:0;color:var(--muted);font-size:0.9rem;line-height:1.5;
    }
    .action-buttons {
      display:flex;gap:12px;flex-wrap:wrap;
    }
    .btn {
      padding:12px 20px;border-radius:var(--radius);border:none;
      font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;
    }
    .btn-primary {
      background:var(--primary);color:#00131f;
    }
    .btn-secondary {
      background:var(--card);color:var(--text);border:1px solid var(--border);
    }
    .btn:disabled {
      opacity:0.6;cursor:not-allowed;
    }
    .btn:hover:not(:disabled) {
      opacity:0.9;
    }
    .status-message {
      margin-top:15px;padding:10px;border-radius:var(--radius);
      background:var(--bg);border:1px solid var(--border);
      color:var(--muted);font-size:0.9rem;display:none;
    }
    .status-success {
      border-color:#10b981;color:#10b981;
    }
    .status-error {
      border-color:#ef4444;color:#ef4444;
    }
    .status-info {
      border-color:var(--primary);color:var(--primary);
    }
    .progress {
      margin-top:12px;height:10px;background:rgba(255,255,255,0.05);border-radius:999px;overflow:hidden;
    }
    .progress > div {
      height:100%;width:0%;background:linear-gradient(90deg,var(--primary),#85d7ff);transition:width .25s;
    }
    footer{margin-top:auto;padding:18px 0;background:var(--card);border-top:1px solid var(--border)}
    .footer-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .footer-links{display:flex;gap:14px;flex-wrap:wrap}
    .footer-links a{color:var(--primary);text-decoration:none;font-weight:600}
    @media (max-width:720px){
      header{flex-direction:column;align-items:flex-start;gap:10px}
      .header-actions{align-self:flex-end}
      .action-buttons{flex-direction:column;}
      .btn{width:100%;justify-content:center;}
    }
  </style>
</head>
<body>
<header class="container">
  <div class="brand">
    <a href="index.html" style="display:flex;align-items:center;gap:12px;text-decoration:none;">
      <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="Smarttool Hub Logo">
      <div>
        <div class="title">Smarttool Hub</div>
        <div class="tag">Fast • Private • 100% Client-side</div>
      </div>
    </a>
  </div>
  <div class="header-actions">
    <a href="index.html" class="btn-header"><i class="fa-solid fa-house"></i> Home</a>
    <button class="btn-header" id="themeToggle" title="Toggle dark/light mode"><i class="fa-solid fa-moon"></i></button>
  </div>
</header>

<main class="container">
  <div class="tool-content">
    <h1 class="tool-title">Unlock PDF</h1>
    <p class="tool-description">Remove password protection from your PDF files. Your files are processed entirely in your browser—no server uploads. (Pages are rasterized during unlocking.)</p>
    
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">
        <i class="fas fa-file-pdf"></i>
      </div>
      <div class="upload-text">Drop your password-protected PDF here or click to browse</div>
      <div class="upload-subtext">Maximum file size: 50MB</div>
      <input type="file" id="fileInput" class="file-input" accept=".pdf">
    </div>
    
    <div id="selectedFileContainer" style="display: none;">
      <div class="selected-file">
        <div class="file-icon">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="file-info">
          <div class="file-name" id="fileName">document.pdf</div>
          <div class="file-size" id="fileSize">0 KB</div>
        </div>
        <button class="remove-file" id="removeFile" title="Remove file">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    
    <div class="password-section">
      <h3>PDF Password</h3>
      <div class="option-group">
        <label for="passwordInput">Enter PDF Password</label>
        <input type="password" id="passwordInput" placeholder="Enter the PDF password to unlock it">
      </div>
      
      <div class="password-note">
        <h4><i class="fas fa-info-circle"></i> Important Information</h4>
        <p>This tool can only remove password protection if you know the current password. It cannot break encryption or bypass passwords for files where you don't have authorization. All processing happens locally in your browser for maximum privacy.</p>
      </div>
    </div>
    
    <div class="action-buttons">
      <button class="btn btn-primary" id="unlockBtn" disabled>
        <i class="fas fa-lock-open"></i> Unlock PDF
      </button>
      <button class="btn btn-secondary" id="downloadBtn" disabled>
        <i class="fas fa-download"></i> Download Unlocked PDF
      </button>
      <button class="btn btn-secondary" id="resetBtn">
        <i class="fas fa-redo"></i> Reset
      </button>
    </div>

    <div id="statusMessage" class="status-message"></div>
    <div class="progress" id="progress" style="display:none"><div></div></div>
  </div>
</main>

<footer class="container">
  <div class="footer-inner">
    <div>© <span id="year"></span> Smarttool Hub</div>
    <div class="footer-links">
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
      <a href="contact.html">Contact</a>
      <a href="comments.html">Comments</a>
      <a href="faq.html">FAQ</a>
    </div>
  </div>
</footer>

<!-- Libraries: PDF.js (for decryption & rendering) + jsPDF for building new PDF -->
<script src="https://unpkg.com/pdfjs-dist@3.11.172/build/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // Set current year
  document.getElementById('year').textContent = new Date().getFullYear();

  // Charting PDF.js worker
  // (use the same version path as the library above)
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.172/build/pdf.worker.min.js';
  }

  // Theme toggle persistence
  const themeToggle = document.getElementById('themeToggle');
  if (localStorage.getItem('sth_theme') === 'light') {
    document.body.classList.add('light');
    themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
  }
  themeToggle.onclick = () => {
    document.body.classList.toggle('light');
    if (document.body.classList.contains('light')) {
      themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
      localStorage.setItem('sth_theme', 'light');
    } else {
      themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
      localStorage.removeItem('sth_theme');
    }
  };

  // Elements
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const selectedFileContainer = document.getElementById('selectedFileContainer');
  const fileNameEl = document.getElementById('fileName');
  const fileSizeEl = document.getElementById('fileSize');
  const removeFileBtn = document.getElementById('removeFile');
  const passwordInput = document.getElementById('passwordInput');
  const unlockBtn = document.getElementById('unlockBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const statusMessage = document.getElementById('statusMessage');
  const progressEl = document.getElementById('progress');
  const progressBar = progressEl.querySelector('div');

  let selectedFile = null;
  let unlockedBlob = null;

  // Drag & drop
  uploadArea.addEventListener('click', () => fileInput.click());
  uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
  uploadArea.addEventListener('drop', handleDrop);
  fileInput.addEventListener('change', handleFileSelect);
  removeFileBtn.addEventListener('click', removeSelectedFile);
  passwordInput.addEventListener('input', updateButtonState);
  unlockBtn.addEventListener('click', unlockPDF);
  downloadBtn.addEventListener('click', downloadUnlockedPDF);
  resetBtn.addEventListener('click', resetTool);

  function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files && files.length > 0) {
      handleFile(files[0]);
    }
  }

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) handleFile(file);
  }

  function handleFile(file) {
    if (!file.type || file.type !== 'application/pdf') {
      showStatus('Please select a PDF file', 'error');
      return;
    }
    if (file.size > 50 * 1024 * 1024) {
      showStatus('File too large. Maximum size is 50 MB.', 'error');
      return;
    }
    selectedFile = file;
    fileNameEl.textContent = file.name;
    fileSizeEl.textContent = formatFileSize(file.size);
    selectedFileContainer.style.display = 'block';
    unlockedBlob = null;
    downloadBtn.disabled = true;
    updateButtonState();
    showStatus('PDF file selected', 'success');
  }

  function removeSelectedFile() {
    selectedFile = null;
    fileInput.value = '';
    selectedFileContainer.style.display = 'none';
    passwordInput.value = '';
    unlockedBlob = null;
    downloadBtn.disabled = true;
    updateButtonState();
    showStatus('File removed', 'info');
  }

  function updateButtonState() {
    unlockBtn.disabled = !(selectedFile && passwordInput.value.length > 0);
  }

  function setProgress(pct) {
    progressEl.style.display = pct >= 0 && pct < 100 ? 'block' : 'none';
    progressBar.style.width = Math.max(0, Math.min(100, pct)) + '%';
  }

  function showStatus(message, type) {
    statusMessage.textContent = message;
    statusMessage.classList.remove('status-success', 'status-error', 'status-info');
    if (type === 'success') statusMessage.classList.add('status-success');
    else if (type === 'error') statusMessage.classList.add('status-error');
    else statusMessage.classList.add('status-info');
    statusMessage.style.display = 'block';
    // hide non-info after a few seconds
    if (type !== 'info') {
      setTimeout(() => { statusMessage.style.display = 'none'; }, 6000);
    }
  }

  async function unlockPDF() {
    if (!selectedFile) {
      showStatus('Please select a PDF file first', 'error');
      return;
    }
    const password = passwordInput.value || undefined;
    showStatus('Loading PDF... (this runs entirely in your browser)', 'info');
    setProgress(2);

    // Read the file as ArrayBuffer
    const arrayBuffer = await selectedFile.arrayBuffer();

    // Use PDF.js to load the PDF with provided password
    let loadingTask;
    try {
      loadingTask = pdfjsLib.getDocument({ data: arrayBuffer, password });
    } catch (err) {
      showStatus('Failed to initialize PDF reader: ' + (err.message || err), 'error');
      setProgress(0);
      return;
    }

    // If PDF.js throws password required or incorrect, it will call promise rejection with special info.
    let pdfDoc;
    try {
      pdfDoc = await loadingTask.promise;
    } catch (reason) {
      // Password required / incorrect
      if (reason && reason.name === 'PasswordException') {
        showStatus('Incorrect password or password required.', 'error');
      } else {
        showStatus('Unable to open PDF: ' + (reason && reason.message ? reason.message : reason), 'error');
      }
      setProgress(0);
      return;
    }

    try {
      const numPages = pdfDoc.numPages;
      if (!numPages || numPages <= 0) {
        showStatus('PDF contains no pages.', 'error');
        setProgress(0);
        return;
      }
      showStatus(`PDF opened — ${numPages} page(s). Rendering pages...`, 'info');

      // Use jsPDF to build final PDF (images). Use UMD exported object
      const { jsPDF } = window.jspdf;

      // We'll create a temporary jsPDF and add pages after rendering each one.
      // First page will initialize size after we get first page dimensions.
      let finalDoc = null;
      let first = true;
      let pageCount = 0;

      for (let i = 1; i <= numPages; i++) {
        setProgress(2 + Math.round((i - 1) / numPages * 90));
        const page = await pdfDoc.getPage(i);

        // Render page to an offscreen canvas at 150 DPI-ish
        const viewport = page.getViewport({ scale: 1.5 }); // scale can be tuned
        const canvas = document.createElement('canvas');
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        const ctx = canvas.getContext('2d');

        const renderContext = {
          canvasContext: ctx,
          viewport: viewport,
        };

        await page.render(renderContext).promise;

        // Convert canvas to JPEG data URL (smaller than PNG usually)
        // quality: 0.92 for decent quality
        const imgData = canvas.toDataURL('image/jpeg', 0.92);

        // Convert page size from points to mm for jsPDF
        // PDF point (pt) = 1/72 inch. 1 inch = 25.4 mm.
        const ptToMm = (pt) => (pt / 72) * 25.4;
        const pageWidthMm = ptToMm(viewport.width);
        const pageHeightMm = ptToMm(viewport.height);

        if (first) {
          // Create jsPDF with orientation matching page
          const orientation = pageWidthMm >= pageHeightMm ? 'landscape' : 'portrait';
          finalDoc = new jsPDF({
            unit: 'mm',
            format: [pageWidthMm, pageHeightMm],
            compress: true,
            orientation
          });
          // Add first image filling the whole page
          finalDoc.addImage(imgData, 'JPEG', 0, 0, pageWidthMm, pageHeightMm, undefined, 'FAST');
          first = false;
        } else {
          // Add new page with same size
          finalDoc.addPage([pageWidthMm, pageHeightMm], pageWidthMm >= pageHeightMm ? 'landscape' : 'portrait');
          finalDoc.addImage(imgData, 'JPEG', 0, 0, pageWidthMm, pageHeightMm, undefined, 'FAST');
        }

        // helpful GC
        page.cleanup && page.cleanup();
        pageCount++;
        // small delay yield (not required, but keeps UI responsive for very large docs)
        await new Promise(r => setTimeout(r, 50));
      }

      setProgress(98);
      showStatus('Finished rendering — creating unlocked PDF...', 'info');

      // Create Blob
      const outputPdfBytes = finalDoc.output('arraybuffer');
      unlockedBlob = new Blob([outputPdfBytes], { type: 'application/pdf' });

      downloadBtn.disabled = false;
      setProgress(100);
      showStatus('PDF successfully unlocked! Click Download to save the unlocked PDF', 'success');

      // cleanup
      pdfDoc.cleanup && pdfDoc.cleanup();
      loadingTask.destroy && loadingTask.destroy();

    } catch (err) {
      console.error(err);
      showStatus('Error while processing PDF: ' + (err.message || err), 'error');
      setProgress(0);
    }
  }

  function downloadUnlockedPDF() {
    if (!unlockedBlob) {
      showStatus('No unlocked PDF available. Please unlock first.', 'error');
      return;
    }
    const url = URL.createObjectURL(unlockedBlob);
    const a = document.createElement('a');
    a.href = url;
    const outName = selectedFile ? 'unlocked-' + selectedFile.name : 'unlocked.pdf';
    a.download = outName;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 150);
    showStatus('Unlocked PDF downloaded successfully', 'success');
  }

  function resetTool() {
    removeSelectedFile();
    unlockedBlob = null;
    setProgress(0);
    downloadBtn.disabled = true;
    showStatus('Tool reset', 'info');
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Initial note
  window.addEventListener('load', () => {
    setTimeout(() => {
      showStatus('Note: This tool requires you to know the PDF password. It cannot break encryption.', 'info');
    }, 800);
  });
</script>
</body>
</html>
