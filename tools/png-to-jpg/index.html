<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PNG ↔ JPG Converter - Bulk Upload & ZIP Download</title>
  <meta name="description" content="Convert multiple images in the browser and download them as a ZIP." />
  <link rel="icon" href="https://img.icons8.com/fluency/48/toolbox.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    :root{--bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;--primary:#22d3ee;--muted:#9fb3c8;--radius:12px}
    body.light{--bg:#f6f8fb;--text:#0b1220;--card:#fff;--border:#e6eefc;--primary:#0b74ff;--muted:#556677}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;transition:background .2s,color .2s}
    .container{max-width:1100px;margin:0 auto;padding:20px;width:100%}
    header{display:flex;align-items:center;justify-content:space-between;background:var(--card);padding:12px 18px;border-radius:10px;border:1px solid var(--border)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:8px}
    .brand .title{font-weight:700;color:var(--primary)}
    .upload-area{margin-top:18px;border-radius:12px;border:2px dashed var(--border);padding:30px;text-align:center;cursor:pointer}
    .upload-area.dragover{border-color:var(--primary);background:rgba(34,211,238,0.03)}
    .file-input{display:none}
    .selected-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:16px}
    .file-card{background:var(--card);padding:10px;border-radius:10px;border:1px solid var(--border);display:flex;gap:10px;align-items:flex-start}
    .thumb{width:84px;height:84px;object-fit:cover;border-radius:8px;background:#0f1720;border:1px solid var(--border)}
    .file-meta h5{margin:0 0 6px 0;font-size:0.95rem}
    .file-actions{display:flex;flex-direction:column;gap:8px;margin-left:auto}
    .small-btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .small-btn.primary{background:var(--primary);color:#00131f}
    .small-btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
    .controls{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .btn{padding:10px 16px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--primary);color:#00131f}
    .btn-secondary{background:var(--card);border:1px solid var(--border);color:var(--text)}
    .status{margin-top:12px;padding:10px;border-radius:10px;display:none}
    .status.ok{border:1px solid #10b981;color:#10b981;background:rgba(16,185,129,0.03)}
    .status.err{border:1px solid #ef4444;color:#ef4444;background:rgba(239,68,68,0.03)}
    footer{margin-top:auto;padding:12px 0;text-align:center;color:var(--muted)}
    @media (max-width:720px){.file-card{flex-direction:row;align-items:center}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="logo">
        <div>
          <div class="title">Smarttool Hub</div>
          <div style="font-size:0.85rem;color:var(--muted)">Bulk image converter & ZIP download</div>
        </div>
      </div>
      <div>
        <button id="themeToggle" class="btn btn-secondary" title="Toggle theme"><i class="fa-solid fa-moon"></i></button>
      </div>
    </header>

    <div class="upload-area" id="uploadArea" title="Click or drop images here">
      <div style="font-size:36px;color:var(--muted)"><i class="fa-solid fa-images"></i></div>
      <div style="margin-top:8px;font-weight:700">Drop images here or click to select (PNG / JPG)</div>
      <div style="margin-top:6px;color:var(--muted)">Multiple files supported</div>
      <input type="file" id="fileInput" class="file-input" accept="image/png,image/jpeg" multiple>
    </div>

    <div class="controls">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="font-weight:700">Conversion:</div>
        <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="format" value="png-to-jpg" checked> PNG → JPG</label>
        <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="format" value="jpg-to-png"> JPG → PNG</label>
      </div>

      <div id="qualityWrap" style="display:flex;gap:8px;align-items:center">
        <div style="font-weight:700">JPG Quality</div>
        <input id="quality" type="range" min="50" max="100" value="85">
        <div id="qualityVal">85%</div>
      </div>

      <button id="convertAllBtn" class="btn btn-primary" disabled><i class="fa-solid fa-sync"></i> Convert All</button>
      <button id="downloadAllBtn" class="btn btn-secondary" disabled><i class="fa-solid fa-download"></i> Download All (ZIP)</button>
      <button id="resetBtn" class="btn btn-secondary"><i class="fa-solid fa-rotate"></i> Reset</button>
    </div>

    <div id="status" class="status"></div>

    <div id="selectedList" class="selected-list" aria-live="polite"></div>
  </div>

  <footer>
    © <span id="year"></span> Smarttool Hub — All conversion happens in your browser.
  </footer>

  <!-- Reliable JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    // small helpers and state
    document.getElementById('year').textContent = new Date().getFullYear();
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const selectedList = document.getElementById('selectedList');
    const convertAllBtn = document.getElementById('convertAllBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusEl = document.getElementById('status');
    const quality = document.getElementById('quality');
    const qualityVal = document.getElementById('qualityVal');
    const qualityWrap = document.getElementById('qualityWrap');
    const themeToggle = document.getElementById('themeToggle');

    let filesState = []; // {id, file, originalDataUrl, convertedDataUrl, outputBlob, convertedName, outputFormat}
    let globalFormat = 'png-to-jpg';
    let currentQuality = Number(quality.value);

    function uid(){ return 'f_' + Math.random().toString(36).slice(2,9); }
    function isImage(f){ return f && (f.type === 'image/png' || f.type === 'image/jpeg'); }
    function showStatus(msg, type='ok', autoHide=true){
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (type==='ok' ? 'ok' : 'err');
      statusEl.style.display = 'block';
      if (autoHide) setTimeout(()=> statusEl.style.display = 'none', 4500);
    }

    // theme toggle
    if (localStorage.getItem('sth_theme') === 'light') {
      document.body.classList.add('light');
      themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
    }
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light');
      if (document.body.classList.contains('light')) {
        themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
        localStorage.setItem('sth_theme', 'light');
      } else {
        themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
        localStorage.removeItem('sth_theme');
      }
    });

    // drag/drop
    uploadArea.addEventListener('click', ()=> fileInput.click());
    uploadArea.addEventListener('dragover', e=>{ e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', e=>{ e.preventDefault(); uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', e=>{ e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(Array.from(e.dataTransfer.files || [])); });

    fileInput.addEventListener('change', e=> { handleFiles(Array.from(e.target.files || [])); fileInput.value = ''; });

    function handleFiles(list){
      const incoming = list.filter(isImage);
      const rejected = list.filter(f => !isImage(f));
      if (rejected.length) showStatus((rejected.length)+' file(s) ignored (not PNG/JPG)', 'err');
      if (!incoming.length) return;
      incoming.forEach(f => {
        const id = uid();
        const entry = { id, file: f, originalDataUrl: null, convertedDataUrl: null, outputBlob: null, convertedName: null, outputFormat: null };
        filesState.push(entry);
        const reader = new FileReader();
        reader.onload = ev => { entry.originalDataUrl = ev.target.result; render(); };
        reader.readAsDataURL(f);
      });
      render();
      showStatus(incoming.length + ' file(s) added', 'ok');
    }

    function render(){
      selectedList.innerHTML = '';
      filesState.forEach(entry => {
        const file = entry.file;
        const card = document.createElement('div'); card.className='file-card';
        const img = document.createElement('img'); img.className='thumb'; img.src = entry.originalDataUrl || '';
        card.appendChild(img);

        const meta = document.createElement('div'); meta.className='file-meta';
        const h5 = document.createElement('h5'); h5.textContent = file.name; meta.appendChild(h5);
        const p1 = document.createElement('p'); p1.textContent = `${file.type.split('/')[1].toUpperCase()} • ${(file.size/1024).toFixed(1)} KB`; meta.appendChild(p1);
        const p2 = document.createElement('p'); p2.style.marginTop='6px';
        p2.innerHTML = entry.outputBlob ? `<span style="font-weight:700;color:var(--primary)">${entry.convertedName}</span> • ${(entry.outputBlob.size/1024).toFixed(1)} KB` : `<span style="color:var(--muted)">Not converted</span>`;
        meta.appendChild(p2);
        card.appendChild(meta);

        const actions = document.createElement('div'); actions.className='file-actions';

        const convertBtn = document.createElement('button'); convertBtn.className='small-btn primary'; convertBtn.textContent='Convert';
        convertBtn.onclick = ()=> convertSingle(entry.id);

        const downloadBtn = document.createElement('button'); downloadBtn.className='small-btn secondary'; downloadBtn.innerHTML = '<i class="fa-solid fa-download"></i> Download';
        downloadBtn.disabled = !entry.outputBlob;
        downloadBtn.onclick = ()=>{
          if(!entry.outputBlob) return;
          const url = URL.createObjectURL(entry.outputBlob);
          const a = document.createElement('a'); a.href = url; a.download = entry.convertedName || file.name;
          document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); document.body.removeChild(a); }, 250);
        };

        const removeBtn = document.createElement('button'); removeBtn.className='small-btn secondary'; removeBtn.innerHTML='<i class="fa-solid fa-trash"></i>';
        removeBtn.onclick = ()=> { filesState = filesState.filter(x=>x.id!==entry.id); render(); updateControls(); showStatus('File removed', 'ok'); };

        actions.appendChild(convertBtn); actions.appendChild(downloadBtn); actions.appendChild(removeBtn);
        card.appendChild(actions);
        selectedList.appendChild(card);
      });
      updateControls();
    }

    function updateControls(){
      convertAllBtn.disabled = filesState.length === 0;
      downloadAllBtn.disabled = filesState.filter(f=>f.outputBlob).length === 0;
    }

    // conversion functions
    function convertSingle(id){
      const entry = filesState.find(x=>x.id===id);
      if(!entry) return;
      const file = entry.file;
      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.onload = ()=> {
          const canvas = document.createElement('canvas');
          canvas.width = img.width; canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(img, 0, 0);

          let outType, q;
          if (globalFormat === 'png-to-jpg') {
            outType = 'image/jpeg'; q = currentQuality/100;
            if (file.type === 'image/png') { // fill alpha with white for JPEG
              ctx.globalCompositeOperation = 'destination-over';
              ctx.fillStyle = '#ffffff';
              ctx.fillRect(0,0,canvas.width,canvas.height);
              ctx.globalCompositeOperation = 'source-over';
            }
          } else {
            outType = 'image/png'; q = 1;
          }

          const dataUrl = canvas.toDataURL(outType, q);
          entry.convertedDataUrl = dataUrl;
          entry.outputBlob = dataURLtoBlob(dataUrl);
          const base = file.name.replace(/\.[^/.]+$/, '');
          const ext = outType === 'image/jpeg' ? 'jpg' : 'png';
          entry.convertedName = `${base}.${ext}`;
          entry.outputFormat = outType;
          render();
          showStatus(`${file.name} converted`, 'ok');
        };
        img.onerror = ()=> showStatus('Failed to load image for conversion', 'err');
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    async function convertAll(){
      if (!filesState.length) { showStatus('No files to convert','err'); return; }
      showStatus('Converting all images...', 'ok', false);
      for (let entry of filesState) {
        await new Promise(resolve=>{
          const file = entry.file;
          const reader = new FileReader();
          reader.onload = ev => {
            const img = new Image();
            img.onload = ()=> {
              const canvas = document.createElement('canvas');
              canvas.width = img.width; canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.clearRect(0,0,canvas.width,canvas.height);
              ctx.drawImage(img, 0, 0);

              let outType, q;
              if (globalFormat === 'png-to-jpg') {
                outType = 'image/jpeg'; q = currentQuality/100;
                if (file.type === 'image/png') {
                  ctx.globalCompositeOperation = 'destination-over';
                  ctx.fillStyle = '#ffffff';
                  ctx.fillRect(0,0,canvas.width,canvas.height);
                  ctx.globalCompositeOperation = 'source-over';
                }
              } else {
                outType = 'image/png'; q = 1;
              }

              const dataUrl = canvas.toDataURL(outType, q);
              entry.convertedDataUrl = dataUrl;
              entry.outputBlob = dataURLtoBlob(dataUrl);
              const base = file.name.replace(/\.[^/.]+$/, '');
              const ext = outType === 'image/jpeg' ? 'jpg' : 'png';
              entry.convertedName = `${base}.${ext}`;
              entry.outputFormat = outType;
              render();
              resolve();
            };
            img.onerror = ()=> { console.warn('image load error for', file.name); resolve(); };
            img.src = ev.target.result;
          };
          reader.readAsDataURL(entry.file);
        });
      }
      showStatus('All images converted', 'ok');
      updateControls();
    }

    // ZIP creation & download
    async function downloadAllAsZip(){
      const converted = filesState.filter(f => f.outputBlob);
      if (!converted.length) { showStatus('No converted files to download', 'err'); return; }

      if (typeof JSZip === 'undefined') {
        console.error('JSZip is not available');
        showStatus('JSZip library not loaded. Cannot create ZIP.', 'err');
        return;
      }

      showStatus('Preparing ZIP — please wait...', 'ok', false);
      try {
        const zip = new JSZip();
        converted.forEach(e => {
          zip.file(e.convertedName, e.outputBlob);
        });

        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } }, (metadata) => {
          // optional progress logging
          // console.log(`zip progress: ${metadata.percent.toFixed(2)}%`);
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.download = `converted_images_${timestamp}.zip`;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=> {
          URL.revokeObjectURL(url);
          try { document.body.removeChild(a); } catch(e){/*ignore*/ }
        }, 500);
        showStatus('ZIP prepared and download triggered', 'ok');
      } catch (err) {
        console.error('ZIP creation failed', err);
        showStatus('Failed creating ZIP: ' + (err && err.message ? err.message : ''), 'err');
      }
    }

    // small helper: convert dataURL to Blob
    function dataURLtoBlob(dataURL){
      const parts = dataURL.split(',');
      const mime = parts[0].match(/:(.*?);/)[1];
      const binary = atob(parts[1]);
      const len = binary.length;
      const u8 = new Uint8Array(len);
      for (let i=0;i<len;i++) u8[i] = binary.charCodeAt(i);
      return new Blob([u8], { type: mime });
    }

    // events
    document.querySelectorAll('input[name="format"]').forEach(r => {
      r.addEventListener('change', e => {
        globalFormat = e.target.value;
        qualityWrap.style.display = globalFormat === 'png-to-jpg' ? 'flex' : 'none';
      });
    });

    quality.addEventListener('input', e => {
      currentQuality = Number(e.target.value);
      qualityVal.textContent = currentQuality + '%';
    });

    convertAllBtn.addEventListener('click', async ()=> {
      await convertAll();
    });

    downloadAllBtn.addEventListener('click', downloadAllAsZip);

    resetBtn.addEventListener('click', ()=>{
      filesState = [];
      selectedList.innerHTML = '';
      updateControls();
      quality.value = 85; currentQuality = 85; qualityVal.textContent = '85%';
      document.querySelector('input[name="format"][value="png-to-jpg"]').checked = true;
      globalFormat = 'png-to-jpg';
      qualityWrap.style.display = 'flex';
      showStatus('Reset complete', 'ok');
    });

    // keyboard accessible: allow space/enter to open file dialog on uploadArea
    uploadArea.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); } });

    // initial
    updateControls();
  </script>
</body>
</html>
