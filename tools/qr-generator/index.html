<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Code Generator (Bulk) - Smarttool Hub</title>
  <meta name="description" content="Generate QR codes one-by-one or in bulk from Excel/CSV. Download PNG/SVG or ZIP." />
  <link rel="icon" href="https://img.icons8.com/fluency/48/toolbox.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    /* Exact same design language used across your uploaded tools */
    :root{--bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;--primary:#22d3ee;--muted:#9fb3c8;--radius:12px}
    body.light{--bg:#f6f8fb;--text:#0b1220;--card:#ffffff;--border:#e6eefc;--primary:#0b74ff;--muted:#556677}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;transition:background .25s,color .25s}
    .container{max-width:1200px;margin:0 auto;padding:20px;width:100%}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border-bottom:1px solid var(--border);padding:14px 20px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:46px;height:46px;border-radius:10px}
    .brand .title{font-size:1.25rem;font-weight:700;color:var(--primary);margin:0}
    .brand .tag{font-size:.9rem;color:var(--muted)}
    .header-actions{display:flex;gap:10px;align-items:center}
    .btn-header{border:1px solid var(--border);background:transparent;padding:8px 12px;border-radius:8px;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;text-decoration:none;font-weight:600}
    .btn-header:hover{border-color:var(--primary);color:var(--primary)}

    .tool-content { background:var(--card);border-radius:var(--radius);border:1px solid var(--border);padding:25px;margin-top:20px; }
    .tool-title { font-size:1.8rem;margin-bottom:5px;color:var(--primary); }
    .tool-description { color:var(--muted);margin-bottom:18px; }

    .grid {
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:18px;
      align-items:start;
    }
    @media (max-width:980px){ .grid { grid-template-columns: 1fr; } }

    .controls {
      background:var(--bg);border:1px solid var(--border);padding:14px;border-radius:10px;
      display:flex;flex-direction:column;gap:12px;
    }
    .form-row { display:flex;gap:10px;align-items:center;flex-wrap:wrap; }
    .form-row label{font-weight:700;color:var(--text);min-width:110px}
    .input, .select, .btn, .color-input, .file-input { background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:8px;color:var(--text);outline:none }
    .textarea { background:var(--card);border:1px solid var(--border);padding:10px;border-radius:8px;color:var(--text);min-height:84px;resize:vertical }
    .small { font-size:0.9rem;color:var(--muted) }

    .preview {
      background:var(--bg);border:1px solid var(--border);padding:18px;border-radius:10px;text-align:center;
      display:flex;flex-direction:column;gap:12px;align-items:center;
    }
    .qr-canvas { width:320px;height:320px;border-radius:8px;background:white;display:flex;align-items:center;justify-content:center; }
    .qr-img { max-width:100%; height:auto; display:block; }

    .options { display:flex;gap:10px;flex-wrap:wrap;align-items:center }
    .btn { padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px; }
    .btn-primary { background:var(--primary);color:#00131f; }
    .btn-secondary { background:var(--card);border:1px solid var(--border);color:var(--text); }
    .btn:disabled { opacity:0.6;cursor:not-allowed; }

    .footer-actions { display:flex;gap:10px;align-items:center;flex-wrap:wrap; }

    .status { color:var(--muted);font-size:0.9rem;margin-top:8px; }

    /* Bulk preview grid */
    .bulk-controls { background:var(--bg);border:1px solid var(--border);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:10px }
    .bulk-meta { display:flex;gap:8px;align-items:center;flex-wrap:wrap }
    .bulk-list { margin-top:12px; display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px; max-height:420px; overflow:auto; padding:6px; }
    .bulk-card { background:var(--card);border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:8px;align-items:center; }
    .bulk-card img { width:120px; height:120px; object-fit:contain; background:white; border-radius:6px; }
    .bulk-card .label { font-size:0.82rem;color:var(--muted); text-align:center; word-break:break-word; max-height:36px; overflow:hidden; }

    .progress { width:100%;height:10px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden }
    .progress .bar { height:100%; width:0%; background:linear-gradient(90deg,var(--primary),#60e7ff); transition:width .2s; }

    footer{margin-top:auto;padding:18px 0;background:var(--card);border-top:1px solid var(--border)}
    .footer-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .footer-links{display:flex;gap:14px;flex-wrap:wrap}
    .footer-links a{color:var(--primary);text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <header class="container">
    <div class="brand">
      <a href="index.html" style="display:flex;align-items:center;gap:12px;text-decoration:none;">
        <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="Smarttool Hub Logo">
        <div>
          <div class="title">Smarttool Hub</div>
          <div class="tag">Fast • Private • 100% Client-side</div>
        </div>
      </a>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn-header"><i class="fa-solid fa-house"></i> Home</a>
      <button class="btn-header" id="themeToggle" title="Toggle dark/light mode"><i class="fa-solid fa-moon"></i></button>
    </div>
  </header>

  <main class="container">
    <div class="tool-content">
      <h1 class="tool-title">QR Code Generator — Single & Bulk (Excel/CSV)</h1>
      <p class="tool-description">Generate single QR codes or bulk-generate from an uploaded Excel/CSV column. Download PNG/SVG individually or all as ZIP. Everything runs in your browser.</p>

      <div class="grid">
        <!-- Left: Controls & Single generator -->
        <div class="controls" id="controlsPanel">
          <div class="form-row">
            <label for="textInput">Text / URL</label>
            <textarea id="textInput" class="textarea" placeholder="Enter URL or text to encode...">https://example.com</textarea>
          </div>

          <div class="form-row">
            <label>Size</label>
            <input id="sizeInput" class="input" type="number" min="64" max="2000" value="320" style="width:110px"/>
            <div class="small">px</div>
            <label style="margin-left:10px">Margin</label>
            <input id="marginInput" class="input" type="number" min="0" max="50" value="4" style="width:80px"/>
          </div>

          <div class="form-row">
            <label>Error correction</label>
            <select id="ecLevel" class="select">
              <option value="L">L — Low (7%)</option>
              <option value="M" selected>M — Medium (15%)</option>
              <option value="Q">Q — Quartile (25%)</option>
              <option value="H">H — High (30%)</option>
            </select>
            <label style="margin-left:12px">Format</label>
            <select id="outFormat" class="select">
              <option value="png" selected>PNG</option>
              <option value="svg">SVG</option>
            </select>
          </div>

          <div class="form-row">
            <label>Colors</label>
            <div class="options">
              <div style="display:flex;flex-direction:column;align-items:center">
                <div class="small">Foreground</div>
                <input id="fgColor" type="color" class="color-input" value="#00131f" />
              </div>
              <div style="display:flex;flex-direction:column;align-items:center">
                <div class="small">Background</div>
                <input id="bgColor" type="color" class="color-input" value="#ffffff" />
              </div>
            </div>
          </div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:6px;">
            <button id="generateBtn" class="btn btn-primary"><i class="fa-solid fa-qrcode"></i> Generate</button>
            <button id="clearBtn" class="btn btn-secondary"><i class="fa-solid fa-trash"></i> Clear</button>
            <div style="margin-left:auto;color:var(--muted);font-weight:700" id="summaryText">Ready</div>
          </div>

          <div class="status" id="status">Tip: paste text or URL, choose size/colors, then generate. For bulk use the Excel uploader on the right.</div>

          <hr style="border:none;border-top:1px solid var(--border);margin:8px 0" />

          <!-- Bulk upload -->
          <div class="bulk-controls">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label style="font-weight:700;color:var(--text);min-width:110px">Upload Excel/CSV</label>
              <input id="bulkFileInput" type="file" class="file-input" accept=".xlsx,.xls,.csv" />
              <button id="chooseBulkBtn" class="btn btn-secondary"><i class="fa-solid fa-file-import"></i> Choose file</button>
            </div>

            <div id="sheetAndColumn" style="display:none;flex-direction:column;gap:8px">
              <div style="display:flex;gap:8px;align-items:center">
                <label style="min-width:110px;color:var(--text);font-weight:700">Worksheet</label>
                <select id="sheetSelect" class="select"></select>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <label style="min-width:110px;color:var(--text);font-weight:700">Column</label>
                <select id="columnSelect" class="select"></select>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <label style="min-width:110px;color:var(--text);font-weight:700">Skip rows</label>
                <input id="skipRows" type="number" class="input" value="0" min="0" style="width:100px" />
                <div class="small" style="margin-left:8px">If header row present set 1</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button id="previewBulkBtn" class="btn btn-secondary">Preview Values</button>
                <button id="bulkGenerateBtn" class="btn btn-primary" disabled><i class="fa-solid fa-layer-group"></i> Generate Bulk</button>
                <button id="downloadAllZipBtn" class="btn btn-secondary" disabled><i class="fa-solid fa-download"></i> Download All (ZIP)</button>
                <div style="margin-left:auto;color:var(--muted);font-weight:700" id="bulkCount">No file</div>
              </div>

              <div class="progress" id="progressBar" style="display:none"><div class="bar" id="progressBarFill"></div></div>
            </div>
          </div>
        </div>

        <!-- Right: Preview & Bulk list -->
        <div class="preview" id="previewPanel">
          <div style="display:flex;gap:12px;align-items:center;width:100%;justify-content:center;">
            <div style="font-weight:700;color:var(--primary)">Preview</div>
            <div id="qrMeta" style="color:var(--muted);font-size:0.9rem"></div>
          </div>

          <div class="qr-canvas" id="qrCanvasWrap" role="img" aria-label="QR code preview">
            <!-- QR will be injected here (img or svg) -->
          </div>

          <div style="display:flex;gap:8px;align-items:center;">
            <button id="downloadPngBtn" class="btn btn-primary" disabled><i class="fa-solid fa-download"></i> Download PNG</button>
            <button id="downloadSvgBtn" class="btn btn-secondary" disabled><i class="fa-solid fa-file-code"></i> Download SVG</button>
            <button id="copyBtn" class="btn btn-secondary" disabled><i class="fa-regular fa-copy"></i> Copy</button>
          </div>

          <div id="bulkArea" style="width:100%;margin-top:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-weight:700;color:var(--primary)">Bulk Preview</div>
              <div style="color:var(--muted);font-size:0.9rem" id="bulkHint">Upload Excel/CSV to bulk-generate</div>
            </div>
            <div id="bulkList" class="bulk-list"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="container">
    <div class="footer-inner">
      <div>© <span id="year"></span> Smarttool Hub</div>
      <div class="footer-links">
        <a href="privacy.html">Privacy</a>
        <a href="terms.html">Terms</a>
        <a href="contact.html">Contact</a>
      </div>
    </div>
  </footer>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    // UI init
    document.getElementById('year').textContent = new Date().getFullYear();
    const themeToggle = document.getElementById('themeToggle');
    if (localStorage.getItem('sth_theme') === 'light') { document.body.classList.add('light'); themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>'; }
    themeToggle.onclick = () => {
      document.body.classList.toggle('light');
      if (document.body.classList.contains('light')) { themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>'; localStorage.setItem('sth_theme','light'); }
      else { themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>'; localStorage.removeItem('sth_theme'); }
    };

    // Elements
    const textInput = document.getElementById('textInput');
    const sizeInput = document.getElementById('sizeInput');
    const marginInput = document.getElementById('marginInput');
    const ecLevel = document.getElementById('ecLevel');
    const outFormat = document.getElementById('outFormat');
    const fgColor = document.getElementById('fgColor');
    const bgColor = document.getElementById('bgColor');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const qrCanvasWrap = document.getElementById('qrCanvasWrap');
    const downloadPngBtn = document.getElementById('downloadPngBtn');
    const downloadSvgBtn = document.getElementById('downloadSvgBtn');
    const copyBtn = document.getElementById('copyBtn');
    const labelInput = document.getElementById('labelInput'); // not present in this view but safe
    const qrMeta = document.getElementById('qrMeta');
    const summaryText = document.getElementById('summaryText');
    const status = document.getElementById('status');

    // Bulk elements
    const bulkFileInput = document.getElementById('bulkFileInput');
    const chooseBulkBtn = document.getElementById('chooseBulkBtn');
    const sheetSelect = document.getElementById('sheetSelect');
    const columnSelect = document.getElementById('columnSelect');
    const sheetAndColumn = document.getElementById('sheetAndColumn');
    const previewBulkBtn = document.getElementById('previewBulkBtn');
    const bulkGenerateBtn = document.getElementById('bulkGenerateBtn');
    const downloadAllZipBtn = document.getElementById('downloadAllZipBtn');
    const bulkCount = document.getElementById('bulkCount');
    const bulkList = document.getElementById('bulkList');
    const bulkHint = document.getElementById('bulkHint');
    const skipRows = document.getElementById('skipRows');
    const progressBar = document.getElementById('progressBar');
    const progressBarFill = document.getElementById('progressBarFill');

    const outFormatSelect = outFormat;

    // State
    let lastDataUrl = null;
    let lastSvgText = null;
    let lastConfig = null;

    // Bulk parsed data
    let workbook = null;
    let currentSheetName = null;
    let bulkValues = []; // array of strings to encode
    let generatedItems = []; // {text, dataUrl or svgText, filename, blob}

    // Helpers
    function sanitizeText(t) { return (t || '').toString(); }
    function updateMeta(){ qrMeta.textContent = `${sizeInput.value}px • margin ${marginInput.value} • EC: ${ecLevel.value}`; }
    function showStatus(msg){ status.textContent = msg; }

    // Single generate
    async function generateQROne() {
      const text = sanitizeText(textInput.value).trim();
      if (!text) { showStatus('Please enter text or URL to encode.'); return; }
      const cfg = getConfig();
      lastConfig = { text, ...cfg };
      showStatus('Generating...');
      try {
        lastDataUrl = await QRCode.toDataURL(text, { errorCorrectionLevel: cfg.ec, margin: cfg.margin, width: cfg.size, color: { dark: cfg.fg, light: cfg.bg } });
        lastSvgText = await new Promise((resolve, reject) => {
          QRCode.toString(text, { type: 'svg', errorCorrectionLevel: cfg.ec, margin: cfg.margin, width: cfg.size, color: { dark: cfg.fg, light: cfg.bg } }, (err, svg) => {
            if (err) return reject(err);
            resolve(svg);
          });
        });
        renderPreview(lastDataUrl, lastSvgText);
        downloadPngBtn.disabled = false;
        downloadSvgBtn.disabled = false;
        copyBtn.disabled = false;
        summaryText.textContent = 'Generated';
        showStatus('QR generated.');
      } catch (err) {
        console.error(err);
        showStatus('QR generation failed: ' + (err && err.message ? err.message : err));
      }
    }

    function getConfig(){
      return {
        size: Math.max(64, Math.min(2000, Number(sizeInput.value) || 320)),
        margin: Math.max(0, Math.min(100, Number(marginInput.value) || 4)),
        ec: ecLevel.value || 'M',
        fg: fgColor.value || '#00131f',
        bg: bgColor.value || '#ffffff',
        format: outFormat.value || 'png'
      };
    }

    function renderPreview(pngDataUrl, svgText){
      qrCanvasWrap.innerHTML = '';
      if (outFormatSelect.value === 'svg' && svgText) {
        try {
          const svgNode = (new DOMParser()).parseFromString(svgText, 'image/svg+xml').documentElement;
          svgNode.style.maxWidth = '100%';
          svgNode.style.height = 'auto';
          qrCanvasWrap.appendChild(svgNode);
        } catch(e) {
          const img = document.createElement('img'); img.className='qr-img'; img.src = pngDataUrl; qrCanvasWrap.appendChild(img);
        }
      } else {
        const img = document.createElement('img'); img.className='qr-img'; img.src = pngDataUrl; qrCanvasWrap.appendChild(img);
      }
    }

    // Download helpers
    function downloadDataUrl(dataUrl, filename) {
      const a = document.createElement('a'); a.href = dataUrl; a.download = filename; document.body.appendChild(a); a.click();
      setTimeout(()=>{ try{ document.body.removeChild(a);}catch(e){} }, 300);
    }
    function downloadSvgText(svgText, filename) {
      const blob = new Blob([svgText], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); try{ document.body.removeChild(a);}catch(e){} }, 400);
    }

    downloadPngBtn.addEventListener('click', () => {
      if (!lastDataUrl) return; const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); downloadDataUrl(lastDataUrl, `qrcode_${ts}.png`);
    });
    downloadSvgBtn.addEventListener('click', () => {
      if (!lastSvgText) return; const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); downloadSvgText(lastSvgText, `qrcode_${ts}.svg`);
    });
    copyBtn.addEventListener('click', async () => {
      try {
        if (outFormat.value === 'svg' && lastSvgText) { await navigator.clipboard.writeText(lastSvgText); showStatus('SVG copied to clipboard.'); }
        else if (lastDataUrl) { await navigator.clipboard.writeText(lastDataUrl); showStatus('PNG data URL copied to clipboard.'); }
      } catch(e){ showStatus('Copy failed (browser may block).'); }
    });

    generateBtn.addEventListener('click', generateQROne);
    clearBtn.addEventListener('click', () => {
      textInput.value = ''; qrCanvasWrap.innerHTML = ''; lastDataUrl = lastSvgText = null; downloadPngBtn.disabled = downloadSvgBtn.disabled = copyBtn.disabled = true; summaryText.textContent='Cleared'; showStatus('Cleared.');
    });

    // Bulk file selection UI
    chooseBulkBtn.addEventListener('click', ()=> bulkFileInput.click());
    bulkFileInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      await handleBulkFile(f);
      e.target.value = '';
    });

    async function handleBulkFile(file) {
      // reset
      workbook = null;
      sheetSelect.innerHTML = '';
      columnSelect.innerHTML = '';
      sheetAndColumn.style.display = 'none';
      bulkValues = [];
      bulkList.innerHTML = '';
      bulkGenerateBtn.disabled = true;
      downloadAllZipBtn.disabled = true;
      bulkHint.textContent = 'Parsing file...';
      bulkCount.textContent = 'Parsing...';

      try {
        const arrayBuffer = await file.arrayBuffer();
        // detect CSV by extension and parse via XLSX read
        const isCsv = /\.csv$/i.test(file.name);
        const wb = XLSX.read(arrayBuffer, { type: "array", raw: false, cellText: false });
        workbook = wb;
        // populate sheet select
        wb.SheetNames.forEach(name => {
          const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sheetSelect.appendChild(opt);
        });
        currentSheetName = wb.SheetNames[0];
        sheetSelect.value = currentSheetName;
        // populate columns from first row (headers) or from A..Z if no header
        populateColumnsForSheet(currentSheetName);
        sheetAndColumn.style.display = 'flex';
        bulkHint.textContent = `File loaded: ${file.name}`;
        bulkCount.textContent = '0 values';
        showStatus('File parsed. Choose worksheet and column.');
      } catch (err) {
        console.error('Failed to parse file', err);
        bulkHint.textContent = 'Parse failed';
        showStatus('Failed to parse Excel/CSV file.');
      }
    }

    function populateColumnsForSheet(sheetName) {
      columnSelect.innerHTML = '';
      const sheet = workbook.Sheets[sheetName];
      if (!sheet) return;
      // try to get header row (row 1) keys
      const range = XLSX.utils.decode_range(sheet['!ref'] || "A1:A1");
      const firstRow = range.s.r; // typically 0
      // build columns from A..Z..AA
      const maxCol = range.e.c;
      for (let c = 0; c <= maxCol; c++) {
        const colLetter = XLSX.utils.encode_col(c);
        // try header cell
        const headerCell = sheet[colLetter + (firstRow+1)];
        const headerText = headerCell ? (headerCell.v || '').toString() : colLetter;
        const opt = document.createElement('option'); opt.value = colLetter; opt.textContent = `${colLetter} — ${headerText}`;
        columnSelect.appendChild(opt);
      }
    }

    sheetSelect.addEventListener('change', (e)=> {
      currentSheetName = e.target.value;
      populateColumnsForSheet(currentSheetName);
    });

    previewBulkBtn.addEventListener('click', ()=> {
      if (!workbook) { showStatus('No file loaded'); return; }
      // extract values in selected column, skipping rows as set
      const col = columnSelect.value;
      const skip = Math.max(0, Number(skipRows.value) || 0);
      const sheet = workbook.Sheets[currentSheetName];
      const rng = XLSX.utils.decode_range(sheet['!ref'] || 'A1:A1');
      const values = [];
      for (let r = skip; r <= rng.e.r; r++) {
        const addr = col + (r+1);
        const cell = sheet[addr];
        const txt = cell ? (cell.v !== undefined ? cell.v : '') : '';
        if (txt !== null && txt !== undefined && String(txt).trim() !== '') values.push(String(txt));
      }
      bulkValues = values;
      bulkList.innerHTML = '';
      generatedItems = [];
      if (!values.length) {
        bulkHint.textContent = 'No values found in column';
        bulkCount.textContent = '0 values';
        bulkGenerateBtn.disabled = true;
        return;
      }
      // show a short preview of first up to 12 values
      const previewCount = Math.min(12, values.length);
      for (let i=0;i<previewCount;i++){
        const card = document.createElement('div'); card.className = 'bulk-card';
        const p = document.createElement('div'); p.className='label'; p.textContent = values[i];
        card.appendChild(p);
        bulkList.appendChild(card);
      }
      bulkHint.textContent = `Previewing first ${previewCount} of ${values.length} values`;
      bulkCount.textContent = `${values.length} values`;
      bulkGenerateBtn.disabled = false;
      downloadAllZipBtn.disabled = true;
      showStatus(`${values.length} values ready for bulk generation.`);
    });

    // Bulk generate
    bulkGenerateBtn.addEventListener('click', async () => {
      if (!bulkValues || !bulkValues.length) { showStatus('No values to generate'); return; }
      generatedItems = [];
      bulkList.innerHTML = '';
      progressBar.style.display = 'block';
      progressBarFill.style.width = '0%';
      const cfg = getConfig();
      const total = bulkValues.length;
      // limit: be careful with huge lists; still proceed but progress indicated
      for (let i=0;i<total;i++){
        const text = bulkValues[i];
        // generate according to format
        try {
          if (cfg.format === 'svg') {
            const svgText = await new Promise((resolve, reject) => {
              QRCode.toString(text, { type: 'svg', errorCorrectionLevel: cfg.ec, margin: cfg.margin, width: cfg.size, color: { dark: cfg.fg, light: cfg.bg } }, (err, svg) => {
                if (err) return reject(err);
                resolve(svg);
              });
            });
            const filename = sanitizeFilename(text, i, 'svg');
            const blob = new Blob([svgText], { type: 'image/svg+xml' });
            generatedItems.push({ text, svgText, filename, blob, format: 'svg' });
            // create thumbnail by embedding svg as data URL
            const imgUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgText);
            pushBulkCard(imgUrl, text, filename);
          } else {
            // PNG path
            const dataUrl = await QRCode.toDataURL(text, { errorCorrectionLevel: cfg.ec, margin: cfg.margin, width: cfg.size, color: { dark: cfg.fg, light: cfg.bg } });
            // convert to blob
            const blob = dataURLtoBlob(dataUrl);
            const filename = sanitizeFilename(text, i, 'png');
            generatedItems.push({ text, dataUrl, filename, blob, format: 'png' });
            pushBulkCard(dataUrl, text, filename);
          }
        } catch (err) {
          console.warn('Failed for item', i, err);
          // create placeholder card with error
          pushBulkCard(null, text, 'error');
        }
        // update progress
        const pct = Math.round(((i+1)/total)*100);
        progressBarFill.style.width = pct + '%';
        await sleep(10); // let UI breathe
      }
      progressBar.style.display = 'none';
      downloadAllZipBtn.disabled = generatedItems.length === 0;
      bulkHint.textContent = `Generated ${generatedItems.length} / ${total}`;
      showStatus('Bulk generation finished.');
    });

    function pushBulkCard(imgUrl, text, filename) {
      const card = document.createElement('div'); card.className = 'bulk-card';
      if (imgUrl) {
        const img = document.createElement('img'); img.src = imgUrl; img.alt = 'QR';
        card.appendChild(img);
      } else {
        const placeholder = document.createElement('div'); placeholder.style.width='120px'; placeholder.style.height='120px'; placeholder.style.display='flex'; placeholder.style.alignItems='center'; placeholder.style.justifyContent='center'; placeholder.style.background='#111827'; placeholder.style.borderRadius='6px';
        placeholder.innerHTML = '<i class="fa-solid fa-triangle-exclamation" style="color:#f59e0b"></i>';
        card.appendChild(placeholder);
      }
      const lbl = document.createElement('div'); lbl.className='label'; lbl.textContent = text;
      card.appendChild(lbl);

      const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px';
      const dlBtn = document.createElement('button'); dlBtn.className='btn btn-secondary'; dlBtn.style.padding='6px 8px'; dlBtn.innerHTML = '<i class="fa-solid fa-download"></i>';
      dlBtn.onclick = async () => {
        // find item by filename
        const item = generatedItems.find(it => it.filename === filename);
        if (!item) { showStatus('Not found'); return; }
        if (item.format === 'svg') downloadSvgText(item.svgText, item.filename);
        else downloadBlob(item.blob, item.filename);
      };
      controls.appendChild(dlBtn);

      const copyBtnLocal = document.createElement('button'); copyBtnLocal.className='btn btn-secondary'; copyBtnLocal.style.padding='6px 8px'; copyBtnLocal.innerHTML='<i class="fa-regular fa-copy"></i>';
      copyBtnLocal.onclick = async () => {
        const it = generatedItems.find(it => it.filename === filename);
        if (!it) return;
        try {
          if (it.format === 'svg') await navigator.clipboard.writeText(it.svgText);
          else await navigator.clipboard.writeText(it.dataUrl);
          showStatus('Copied to clipboard');
        } catch(e){ showStatus('Copy failed'); }
      };
      controls.appendChild(copyBtnLocal);

      card.appendChild(controls);
      bulkList.appendChild(card);
    }

    function sanitizeFilename(text, index, ext) {
      let base = text && String(text).trim().slice(0,60) || `qr_${index+1}`;
      base = base.replace(/[\\\/:*?"<>|]/g, '-').replace(/\s+/g,'_');
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      return `${base}_${ts}.${ext}`;
    }

    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]); let n = bstr.length; const u8arr = new Uint8Array(n);
      while(n--){ u8arr[n] = bstr.charCodeAt(n); }
      return new Blob([u8arr], { type: mime });
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); try{ document.body.removeChild(a);}catch(e){} }, 400);
    }

    function sleep(ms){ return new Promise(res=>setTimeout(res,ms)); }

    // Download all as ZIP
    downloadAllZipBtn.addEventListener('click', async () => {
      if (!generatedItems || !generatedItems.length) { showStatus('No generated items'); return; }
      if (typeof JSZip === 'undefined') { showStatus('JSZip missing'); return; }
      showStatus('Preparing ZIP...');
      const zip = new JSZip();
      for (let i=0;i<generatedItems.length;i++){
        const it = generatedItems[i];
        try {
          if (it.format === 'svg') zip.file(it.filename, it.blob);
          else zip.file(it.filename, it.blob);
        } catch(e){ console.warn('zip add failed', e); }
      }
      const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } }, (meta) => {
        progressBar.style.display = 'block';
        progressBarFill.style.width = Math.round(meta.percent) + '%';
      });
      progressBar.style.display = 'none';
      downloadBlob(blob, `qr_bulk_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`);
      showStatus('ZIP ready.');
    });

    // small UI niceties
    sheetAndColumn.style.display = 'none';
    chooseBulkBtn.addEventListener('keydown', (e) => { if (e.key === 'Enter') bulkFileInput.click(); });

    // initial meta update
    updateMeta();
    [sizeInput, marginInput, ecLevel, fgColor, bgColor, outFormat].forEach(el => el.addEventListener('input', updateMeta));
    outFormat.addEventListener('change', () => {
      if (lastDataUrl || lastSvgText) renderPreview(lastDataUrl, lastSvgText);
    });

    // helper: convert CSV raw parse when workbook read has single sheet but raw header less
    // (XLSX already handled parsing)

    // keyboard: Ctrl+Enter to generate single
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { generateQROne(); }
    });

    // Expose for debugging
    window._bulk_qr_state = () => ({ workbookLoaded: !!workbook, currentSheetName, bulkValuesLength: bulkValues.length, generatedItemsLength: generatedItems.length });

  </script>
</body>
</html>
