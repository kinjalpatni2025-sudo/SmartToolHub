<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QR Code Scanner - Smarttool Hub (Fixed)</title>
  <meta name="description" content="Scan QR codes with camera or upload image. Uses jsQR for decoding."/>
  <link rel="icon" href="https://img.icons8.com/fluency/48/toolbox.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    :root{
      --bg:#0b1220;--text:#eaf2ff;--card:#182335;--border:#2a3b55;
      --primary:#22d3ee;--muted:#9fb3c8;--radius:12px;
    }
    body.light{
      --bg:#f6f8fb;--text:#0b1220;--card:#ffffff;--border:#e6eefc;
      --primary:#0b74ff;--muted:#556677;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg);color:var(--text);transition:background .25s,color .25s;
      min-height:100vh;display:flex;flex-direction:column;
    }
    .container{max-width:1200px;margin:0 auto;padding:20px;width:100%}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:var(--card);border-bottom:1px solid var(--border);padding:14px 20px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:46px;height:46px;border-radius:10px}
    .brand .title{font-size:1.25rem;font-weight:700;color:var(--primary);margin:0}
    .brand .tag{font-size:.9rem;color:var(--muted)}
    .header-actions{display:flex;gap:10px;align-items:center}
    .btn-header{
      border:1px solid var(--border);background:transparent;padding:8px 12px;border-radius:8px;
      color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;text-decoration:none;font-weight:600
    }
    .btn-header:hover{border-color:var(--primary);color:var(--primary)}

    /* Tool content */
    .tool-content {
      background:var(--card);border-radius:var(--radius);border:1px solid var(--border);
      padding:25px;margin-top:20px;
    }
    .tool-title { font-size:1.8rem;margin-bottom:5px;color:var(--primary); }
    .tool-description { color:var(--muted);margin-bottom:18px; }

    .scanner-grid { display:grid; grid-template-columns: 1fr 380px; gap:18px; align-items:start; }
    @media (max-width:980px){ .scanner-grid { grid-template-columns: 1fr; } }

    /* Camera area */
    .camera-box {
      border:1px solid var(--border);border-radius:var(--radius);padding:12px;background:var(--bg);
      display:flex;flex-direction:column;gap:12px;align-items:stretch;
    }
    .camera-header { display:flex;gap:12px;align-items:center;justify-content:space-between; }
    .camera-view { width:100%;min-height:360px;border-radius:8px;background:#071021;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;}
    .camera-placeholder { color:var(--muted);font-weight:600;display:flex;align-items:center;gap:10px;font-size:1rem; }
    video#qr-video { width:100%; height:100%; object-fit:cover; display:block; }
    canvas#overlay { position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; }

    .controls-row { display:flex;gap:10px;flex-wrap:wrap;align-items:center; }
    .select-camera { background:var(--card);border:1px solid var(--border);padding:8px;border-radius:8px;color:var(--text); }
    .btn { padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px; }
    .btn-primary { background:var(--primary);color:#00131f; }
    .btn-secondary { background:var(--card);border:1px solid var(--border);color:var(--text); }

    /* Sidebar info */
    .info-panel { border:1px solid var(--border);border-radius:var(--radius);padding:12px;background:var(--bg); }
    .info-panel h4 { margin:0 0 8px 0;color:var(--primary); }
    .result-box { background:#06121a;border-radius:8px;padding:10px;border:1px solid var(--border);min-height:80px;color:var(--muted);overflow-wrap:anywhere; }
    .result-actions { display:flex;gap:8px;margin-top:10px;flex-wrap:wrap; }
    .history-list { margin-top:12px; display:flex;flex-direction:column; gap:8px; max-height:220px; overflow:auto; }
    .history-item { padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--card);font-size:0.9rem;display:flex;justify-content:space-between;gap:8px;align-items:center;}
    .history-item button { padding:6px 8px;border-radius:8px;border:none;cursor:pointer;background:transparent;color:var(--primary);font-weight:700; }

    .upload-fallback { margin-top:6px; display:flex;gap:8px;align-items:center; }
    .file-input { display:none; }

    .status { margin-top:8px;color:var(--muted);font-size:0.9rem; }

    footer{margin-top:auto;padding:18px 0;background:var(--card);border-top:1px solid var(--border)}
    .footer-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .footer-links{display:flex;gap:14px;flex-wrap:wrap}
    .footer-links a{color:var(--primary);text-decoration:none;font-weight:600}
  </style>
</head>
<body>
<header class="container">
  <div class="brand">
    <a href="index.html" style="display:flex;align-items:center;gap:12px;text-decoration:none;">
      <img src="https://img.icons8.com/fluency/48/toolbox.png" alt="Smarttool Hub Logo">
      <div>
        <div class="title">Smarttool Hub</div>
        <div class="tag">Fast • Private • 100% Client-side</div>
      </div>
    </a>
  </div>
  <div class="header-actions">
    <a href="index.html" class="btn-header"><i class="fa-solid fa-house"></i> Home</a>
    <button class="btn-header" id="themeToggle" title="Toggle dark/light mode"><i class="fa-solid fa-moon"></i></button>
  </div>
</header>

<main class="container">
  <div class="tool-content">
    <h1 class="tool-title">QR Code Scanner</h1>
    <p class="tool-description">Scan QR codes using your camera or upload an image. All processing happens in your browser — no files are uploaded to a server.</p>

    <div class="scanner-grid">
      <!-- Camera / Scanner area -->
      <div class="camera-box">
        <div class="camera-header">
          <div style="font-weight:700;color:var(--text)">Live Scanner</div>
          <div style="color:var(--muted);font-size:0.9rem" id="cameraStatus">Not started</div>
        </div>

        <div class="camera-view" id="cameraView">
          <div class="camera-placeholder" id="cameraPlaceholder"><i class="fa-solid fa-video"></i> Camera feed will appear here</div>
          <!-- video element will be appended here -->
        </div>

        <div class="controls-row">
          <select id="cameraSelect" class="select-camera" aria-label="Choose camera"></select>
          <button class="btn btn-primary" id="startBtn"><i class="fa-solid fa-play"></i> Start</button>
          <button class="btn btn-secondary" id="stopBtn" disabled><i class="fa-solid fa-stop"></i> Stop</button>

          <label class="upload-fallback" style="margin-left:auto">
            <input type="file" id="fileInput" accept="image/*" class="file-input">
            <button class="btn btn-secondary" id="uploadBtn"><i class="fa-solid fa-upload"></i> Upload Image</button>
          </label>
        </div>

        <div class="status" id="scanHint">Tip: allow camera access, then point camera at a QR code.</div>
      </div>

      <!-- Sidebar: results + history -->
      <div class="info-panel">
        <h4>Decoded Result</h4>
        <div class="result-box" id="resultBox">No QR code scanned yet.</div>
        <div class="result-actions">
          <button class="btn btn-primary" id="copyBtn" disabled><i class="fa-regular fa-copy"></i> Copy</button>
          <button class="btn btn-secondary" id="openBtn" disabled><i class="fa-solid fa-up-right-from-square"></i> Open</button>
          <button class="btn btn-secondary" id="clearHistoryBtn" title="Clear history"><i class="fa-solid fa-trash"></i> Clear History</button>
        </div>

        <h4 style="margin-top:14px">Scan History</h4>
        <div class="history-list" id="historyList"></div>
      </div>
    </div>
  </div>
</main>

<footer class="container">
  <div class="footer-inner">
    <div>© <span id="year"></span> Smarttool Hub</div>
    <div class="footer-links">
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
      <a href="contact.html">Contact</a>
    </div>
  </div>
</footer>

<!-- jsQR for decoding -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
  // UI & theme
  document.getElementById('year').textContent = new Date().getFullYear();
  const themeToggle = document.getElementById('themeToggle');
  if (localStorage.getItem('sth_theme') === 'light') {
    document.body.classList.add('light');
    themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
  }
  themeToggle.onclick = () => {
    document.body.classList.toggle('light');
    if (document.body.classList.contains('light')) { themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>'; localStorage.setItem('sth_theme','light'); }
    else { themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>'; localStorage.removeItem('sth_theme'); }
  };

  // Elements
  const cameraView = document.getElementById('cameraView');
  const cameraPlaceholder = document.getElementById('cameraPlaceholder');
  const cameraSelect = document.getElementById('cameraSelect');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const cameraStatus = document.getElementById('cameraStatus');

  const resultBox = document.getElementById('resultBox');
  const copyBtn = document.getElementById('copyBtn');
  const openBtn = document.getElementById('openBtn');
  const historyList = document.getElementById('historyList');
  const clearHistoryBtn = document.getElementById('clearHistoryBtn');

  // scanner state
  let video = null;
  let overlayCanvas = null;
  let overlayCtx = null;
  let offscreenCanvas = null;
  let offscreenCtx = null;
  let animationId = null;
  let currentStream = null;
  let scanHistory = [];
  let lastDecoded = null;
  let scanPauseUntil = 0;

  // helpers
  function showResult(text) {
    lastDecoded = text;
    resultBox.textContent = text;
    copyBtn.disabled = false;
    try {
      const url = new URL(text);
      openBtn.disabled = false;
      openBtn.onclick = () => window.open(text, '_blank');
    } catch (e) {
      openBtn.disabled = true;
      openBtn.onclick = null;
    }
    addHistory(text);
  }

  function addHistory(text) {
    if (scanHistory.length && scanHistory[0] === text) return;
    scanHistory.unshift(text);
    if (scanHistory.length > 80) scanHistory.pop();
    renderHistory();
  }

  function renderHistory() {
    historyList.innerHTML = '';
    for (let i = 0; i < scanHistory.length; i++) {
      const t = scanHistory[i];
      const item = document.createElement('div');
      item.className = 'history-item';
      const left = document.createElement('div'); left.style.flex = '1'; left.textContent = t.length > 80 ? t.slice(0,80) + '…' : t;
      const right = document.createElement('div'); right.style.display = 'flex'; right.style.gap = '8px';
      const useBtn = document.createElement('button'); useBtn.textContent = 'Use'; useBtn.onclick = () => showResult(t);
      const copyBtnLocal = document.createElement('button'); copyBtnLocal.textContent = 'Copy'; copyBtnLocal.onclick = async () => { try { await navigator.clipboard.writeText(t); showToast('Copied'); } catch(e) { showToast('Copy failed'); } };
      right.appendChild(useBtn); right.appendChild(copyBtnLocal);
      item.appendChild(left); item.appendChild(right);
      historyList.appendChild(item);
    }
  }

  function showToast(msg) {
    const toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.right = '20px';
    toast.style.padding = '10px 14px';
    toast.style.borderRadius = '8px';
    toast.style.background = '#0f1720';
    toast.style.color = '#eaf2ff';
    toast.style.zIndex = 9999;
    document.body.appendChild(toast);
    setTimeout(()=> { try { document.body.removeChild(toast); } catch(e){} }, 1300);
  }

  copyBtn.addEventListener('click', async () => {
    if (!lastDecoded) return;
    try { await navigator.clipboard.writeText(lastDecoded); showToast('Copied to clipboard'); } catch(e) { showToast('Copy failed'); }
  });

  clearHistoryBtn.addEventListener('click', () => { scanHistory = []; renderHistory(); showToast('History cleared'); });

  // enumerate cameras
  async function populateCameraList() {
    cameraSelect.innerHTML = '';
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoInputs = devices.filter(d => d.kind === 'videoinput');
      if (!videoInputs.length) {
        cameraSelect.innerHTML = '<option>No camera found</option>';
        return;
      }
      videoInputs.forEach((dev, idx) => {
        const o = document.createElement('option');
        o.value = dev.deviceId;
        o.textContent = dev.label || `Camera ${idx+1}`;
        cameraSelect.appendChild(o);
      });
    } catch (err) {
      cameraSelect.innerHTML = '<option>Error listing cameras</option>';
      console.warn('enumerateDevices failed', err);
    }
  }

  // create video and canvas
  function ensureVideoAndCanvases() {
    if (!video) {
      video = document.createElement('video');
      video.id = 'qr-video';
      video.autoplay = true;
      video.playsInline = true;
      video.muted = true;
      video.style.width = '100%';
      video.style.height = '100%';
      cameraView.appendChild(video);
    }
    // overlay for drawing box
    if (!overlayCanvas) {
      overlayCanvas = document.createElement('canvas');
      overlayCanvas.id = 'overlay';
      overlayCanvas.style.position = 'absolute';
      overlayCanvas.style.left = '0';
      overlayCanvas.style.top = '0';
      overlayCanvas.style.width = '100%';
      overlayCanvas.style.height = '100%';
      overlayCanvas.style.pointerEvents = 'none';
      cameraView.appendChild(overlayCanvas);
      overlayCtx = overlayCanvas.getContext('2d');
    }
    // offscreen canvas to grab frame pixels
    if (!offscreenCanvas) {
      offscreenCanvas = document.createElement('canvas');
      offscreenCtx = offscreenCanvas.getContext('2d');
    }
  }

  // start camera with chosen deviceId (or default)
  async function startCamera(deviceId = null) {
    // stop existing
    stopCamera();

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      cameraStatus.textContent = 'Camera API not supported';
      showToast('Camera not supported');
      return;
    }

    ensureVideoAndCanvases();
    cameraPlaceholder.style.display = 'none';
    cameraStatus.textContent = 'Starting camera...';
    showToast('Starting camera');

    try {
      const constraints = { video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' } };
      currentStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = currentStream;

      // wait for video to be playing and have width/height
      await new Promise((resolve, reject) => {
        let settled = false;
        const onPlay = () => {
          if (settled) return;
          if (video.videoWidth && video.videoHeight) {
            settled = true;
            resolve();
          }
        };
        video.addEventListener('loadedmetadata', onPlay, { once: true });
        video.addEventListener('playing', onPlay, { once: true });
        // fallback timeout
        setTimeout(() => {
          if (!settled) { settled = true; resolve(); }
        }, 1500);
      });

      // set overlay canvas size to video actual size
      overlayCanvas.width = video.videoWidth;
      overlayCanvas.height = video.videoHeight;
      offscreenCanvas.width = video.videoWidth;
      offscreenCanvas.height = video.videoHeight;

      stopBtn.disabled = false;
      startBtn.disabled = true;
      cameraStatus.textContent = 'Camera running';
      scanLoop(); // begin scanning frames
    } catch (err) {
      console.error('startCamera error', err);
      cameraPlaceholder.style.display = 'flex';
      cameraStatus.textContent = 'Camera error: ' + (err && err.message ? err.message : 'Permission denied or not available');
      showToast('Camera failed — try upload');
      stopBtn.disabled = true;
      startBtn.disabled = false;
    }
  }

  // stop camera & scanning
  function stopCamera() {
    if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
    if (video) {
      video.pause();
      try { video.srcObject = null; } catch(e){}
      // remove video from DOM to mimic previous behavior? we keep it but hide placeholder when stopped
      // cameraView.removeChild(video); // optional
    }
    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
    }
    if (overlayCtx) {
      overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
    }
    cameraPlaceholder.style.display = 'flex';
    cameraStatus.textContent = 'Camera stopped';
    stopBtn.disabled = true;
    startBtn.disabled = false;
  }

  // scanning loop using jsQR
  function scanLoop() {
    if (!video || video.readyState !== HTMLMediaElement.HAVE_ENOUGH_DATA) {
      animationId = requestAnimationFrame(scanLoop);
      return;
    }

    try {
      offscreenCtx.drawImage(video, 0, 0, offscreenCanvas.width, offscreenCanvas.height);
      const imageData = offscreenCtx.getImageData(0, 0, offscreenCanvas.width, offscreenCanvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

      overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      if (code) {
        // draw bounding box scaled to canvas size
        drawLine(code.location.topLeftCorner, code.location.topRightCorner);
        drawLine(code.location.topRightCorner, code.location.bottomRightCorner);
        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner);
        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner);

        // debounce repeated findings: only accept if different or after small pause
        const now = Date.now();
        if (code.data && (code.data !== lastDecoded || now > scanPauseUntil)) {
          lastDecoded = code.data;
          scanPauseUntil = now + 1200; // pause for 1.2s before repeating same code
          showResult(code.data);
        }
      }
    } catch (err) {
      console.warn('scanLoop error', err);
    }

    animationId = requestAnimationFrame(scanLoop);
  }

  function drawLine(pt1, pt2) {
    overlayCtx.strokeStyle = '#22d3ee';
    overlayCtx.lineWidth = Math.max(2, overlayCanvas.width / 200);
    overlayCtx.beginPath();
    overlayCtx.moveTo(pt1.x, pt1.y);
    overlayCtx.lineTo(pt2.x, pt2.y);
    overlayCtx.stroke();
  }

  // upload image scanning
  uploadBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', async (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    cameraStatus.textContent = 'Scanning image...';
    try {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          // set offscreen to image size
          if (!offscreenCanvas) {
            offscreenCanvas = document.createElement('canvas');
            offscreenCtx = offscreenCanvas.getContext('2d');
          }
          offscreenCanvas.width = img.width;
          offscreenCanvas.height = img.height;
          offscreenCtx.drawImage(img, 0, 0);
          const imageData = offscreenCtx.getImageData(0, 0, img.width, img.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          overlayCtx && overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
          if (code) {
            // show result and draw small overlay in camera view (scaled)
            showResult(code.data);
            // draw bounding box to overlay scaled properly
            ensureVideoAndCanvases();
            // scale overlay canvas to image natural size and draw
            overlayCanvas.width = img.width;
            overlayCanvas.height = img.height;
            overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
            drawLine(code.location.topLeftCorner, code.location.topRightCorner);
            drawLine(code.location.topRightCorner, code.location.bottomRightCorner);
            drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner);
            drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner);
            showToast('QR code detected in image');
          } else {
            showToast('No QR detected in image');
          }
          cameraStatus.textContent = 'Image scanned';
        };
        img.onerror = () => {
          showToast('Failed to load image');
          cameraStatus.textContent = 'Image load failed';
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(f);
    } catch (err) {
      console.error('Image scan failed', err);
      showToast('Image scan failed');
      cameraStatus.textContent = 'Image scan failed';
    } finally {
      fileInput.value = '';
    }
  });

  // event wiring for start/stop
  startBtn.addEventListener('click', async () => {
    const deviceId = cameraSelect.value || null;
    await startCamera(deviceId);
  });
  stopBtn.addEventListener('click', () => stopCamera());

  // camera selection change: if running, restart with new device
  cameraSelect.addEventListener('change', async () => {
    if (currentStream) {
      await startCamera(cameraSelect.value);
    }
  });

  // initial setup
  (async function init() {
    await populateCameraList();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    cameraPlaceholder.style.display = 'flex';
    ensureVideoAndCanvases();
    cameraStatus.textContent = 'Ready';
    // attempt to pick the first camera automatically if available (do not auto-start)
    if (cameraSelect.options.length) cameraSelect.selectedIndex = 0;
  })();

  // cleanup on unload
  window.addEventListener('beforeunload', () => { stopCamera(); });

  // prevent accidental multiple clicks, small helper
  function debounceButton(btn, ms=800) {
    btn.disabled = true;
    setTimeout(()=> btn.disabled = false, ms);
  }
</script>
</body>
</html>
